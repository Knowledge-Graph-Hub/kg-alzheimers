pipeline {
    agent {
        docker {
            label 'worker'
            image 'python:3.8-buster'
        }
    }
    environment {
        HOME = "${env.WORKSPACE}"
    }
    stages {
        stage('setup') {
            steps {
                sh '''
                    curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
                    chmod 755 $HOME/.poetry/env
                    $HOME/.poetry/bin/poetry install
                '''
            }
        }
        stage('download and mirror') {
            steps {
                sh '''
                    $HOME/.poetry/bin/poetry run downloader download.yaml --mirror gs://monarch-ingest/download-cache
                '''
            }
        }
    }
}
