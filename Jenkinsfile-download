pipeline {
    agent {
        docker {
            label 'worker'
            image 'python:3.8-buster'
        }
    }
    environment {
        HOME = "${env.WORKSPACE}"
    }
    stages {
        stage('setup') {
            steps {
                sh '''
                    python -mvenv venv
                    . venv/bin/activate
                    pip install click==8.0.4
                    pip install kghub-downloader
                '''
            }
        }
        stage('download') {
            steps {
                sh '''
                    . venv/bin/activate
                    downloader
                '''
            }
        }
        stage('post-process') {
            steps {
                sh '''
                    zcat data/alliance/BGI_*.gz | jq '.data[].basicGeneticEntity.primaryId' | gzip > data/alliance/alliance_gene_ids.txt.gz
                '''
                sh '''
                    tar -xOf ./data/panther/RefGenomeOrthologs.tar.gz > ./data/panther/RefGenomeOrthologs.tsv
                '''
            }
        }
        stage('upload') {
            steps {
                sh '''
                    gsutil -m cp -r data/ gs://monarch-ingest/data-cache
                '''
            }
        }
    }
}
