pipeline {
    agent { label 'monarch-agent-medium' }
    triggers {
        cron('H H * * 7')  //sometime on Sundays
    }
    environment {
        HOME = "${env.WORKSPACE}"
        PATH = "/opt/poetry/bin:${env.PATH}"
        OMIM_API_KEY = credentials('OMIM_API_KEY')
    }
    stages {
        stage('setup') {
            steps {
                sh '''
                poetry install
                '''
            }
        }
        stage('download') {
            steps {
                sh '''
                poetry run downloader monarch_ingest/download.yaml
                '''
            }
        }
        stage('post-process') {
            steps {
                sh '''
                    zcat data/alliance/BGI_*.gz | jq '.data[].basicGeneticEntity.primaryId' | gzip > data/alliance/alliance_gene_ids.txt.gz
                    sqlite3 -cmd ".mode tabs" -cmd ".headers on" data/dictybase/ddpheno.db "select subject as id, value as name from rdfs_label_statement where predicate = 'rdfs:label' and subject like 'DDPHENO:%'" > data/dictybase/ddpheno.tsv
                '''
            }
        }
        stage('upload') {
            steps {
                sh '''
                    gsutil -m cp -r data/* gs://monarch-ingest-data-cache
                '''
            }
        }
    }
}
