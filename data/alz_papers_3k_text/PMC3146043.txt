# Title
Transcript assembly and abundance estimation from RNA-Seq reveals thousands of new transcripts and switching among isoforms

# Abstract
High-throughput mRNA sequencing (RNA-Seq) holds the promise of simultaneous transcript discovery and abundance estimation 1 - 3 . We introduce an algorithm for transcript assembly coupled with a statistical model for RNA-Seq experiments that produces estimates of abundances. Our algorithms are implemented in an open source software program called Cufflinks. To test Cufflinks, we sequenced and analyzed more than 430 million paired 75bp RNA-Seq reads from a mouse myoblast cell line representing a differentiation time series. We detected 13,692 known transcripts and 3,724 previously unannotated ones, 62% of which are supported by independent expression data or by homologous genes in other species. Analysis of transcript expression over the time series revealed complete switches in the dominant transcription start site (TSS) or splice-isoform in 330 genes, along with more subtle shifts in a further 1,304 genes. These dynamics suggest substantial regulatory flexibility and complexity in this well-studied model of muscle development.

## Methods
Mouse skeletal muscle C2C12 cells were initially plated on 15 cm plates in DMEM with 20% fetal bovine serum. At confluence, the cells were switched to low serum medium to initiate myogenic differentiation. For extraction of total RNA, cells were first rinsed in PBS and then lysed in Trizol reagent (Invitrogen catalog # 15596-026) either during exponential growth in high serum medium, or at 60 hrs, 5 days and 7 days after medium shift. Residual contaminating genomic DNA was removed from the total RNA fraction using Turbo DNA-free (Ambion catalog # AM1907M). mRNA was isolated from DNA-free total RNA using the Dynabeads mRNA Purification Kit (Invitrogen catalog # 610-06).

Preparation of cDNA followed the procedure described in Mortazavi et al. 2 , with minor modifications as described below. Prior to fragmentation, a 7 uL aliquot (∼ 500 pgs total mass) containing known concentrations of 7 “spiked in” control transcripts from A. thaliana and the lambda phage genome were added to a 100 ng aliquot of mRNA from each time point. This mixture was then fragmented to an average length of 200 nts by metal ion/heat catalyzed hydrolysis. The hydrolysis was performed in a 25 uL volume at 94°C for 90 seconds. The 5X hydrolyis buffer components are: 200 mM Tris acetate, pH 8.2, 500 mM potassium acetate and 150 mM magnesium acetate. After removal of hydrolysis ions by G50 Sephadex filtration (USA Scientific catalog # 1415-1602), the fragmented mRNA was random primed with hexamers and reverse-transcribed using the Super Script II cDNA synthesis kit (Invitrogen catalog # 11917010). After second strand synthesis, the cDNA went through end-repair and ligation reactions according to the Illumina ChIP-Seq genomic DNA preparation kit protocol (Illumina catalog # IP102-1001), using the paired end adapters and amplification primers (Illumina Catalog # PE102-1004). Ligation of the adapters adds 94 bases to the length of the cDNA molecules.

The cDNA library was size-fractionated on a 2% TAE low melt agarose gel (Lonza catalog # 50080), with a 100 bp ladder (Roche catalog # 14703220) run in adjacent lanes. Prior to loading on the gel, the ligated cDNA library was taken over a G50 Sephadex column to remove excess salts that interfere with loading the sample in the wells. After post-staining the gel in ethidium bromide, a narrow slice (∼2mm) of the cDNA lane centered at the 300 bp marker was cut. The slice was extracted using the QiaEx II kit (Qiagen catalog # 20021), and the extract was filtered over a Microcon YM-100 microconcentrator (Millipore catalog # 42409) to remove DNA fragments shorter than 100 bps. Filtration was performed by pipeting the extract into the upper chamber of a microconcentrator, and adding ultra pure water (Gibco catalog # 10977) to a volume of 500 uLs. The filter was spun at 500 X g until only 50 uLs remained in the upper chamber (about 20 minutes per spin) and then the upper chamber volume was replenished to 500 uLs. This procedure was repeated 6 times. The filtered sample was then recovered from the filter chamber according to the manufacturer's protocol. Fragment length distributions obtained after size selection were estimated from the spike-in sequences and are show in Supplementary Fig. 1 .

One-sixth of the filtered sample volume was used as template for 15 cycles of amplification using the paired-end primers and amplification reagents supplied with the Illumina ChIP-Seq genomic DNA prep kit. The amplified product was then cleaned up over a Qiaquick PCR column (Qiagen catalog # 28104), and then the filtration procedure using the Microcon YM-100 microconcentrators described above was repeated, to remove both amplification primers and amplification products shorter than 100 bps. A final pass over a G50 Sephadex column was performed, and the library was quantified using the Qubit fluorometer and PicoGreen quantification reagents (Invitrogen catalog # Q32853). The library was then used to build clusters on the Illumina flow cell according to protocol.

Fragments were mapped to build 37.1 of the mouse genome using TopHat version 1.0.13. We extended our previous algorithms to exploit the longer paired reads used in the study. TopHat version 1.0.7 and later splits a read 75bp or longer in three or more segments of approximately equal size (25bp), and maps them independently. Reads with segments that can be mapped to the genome only non-contiguously are marked as possible intron-spanning reads. These “contiguously unmappable” reads are used to build a set of possible introns in the transcriptome. TopHat accumulates an index of potential splice junctions by examining segment mapping for all contiguously unmappable reads. For each junction the program then concatenates kbp upstream of the donor to kbp downstream of the acceptor to form a synthetic spliced sequence around the junction. The segments of the contiguously unmappable reads are then aligned against these synthetic sequences with Bowtie. The resulting contiguous and spliced segment alignments for these reads are merged to form complete alignments to the genome, each spanning one or more splice junctions. Further details of how version 1.0.13 of TopHat differs from the published algorithm are provided in Section 2 of the Supplementary Methods .

We estimated transcript abundances using a generative statistical model of RNA-Seq experiments. The model was parameterized by the relative abundances of the set of all transcripts in a sample. For computational convenience, abundances of non-overlapping transcripts in disjoint genomic loci were calculated independently. The parameters of the model were the non-negative abundances ρ t . Denoting the fragment distribution by F , we defined the effective length of a transcript to be

where l(t) is the length of a transcript. The likelihood function for our model was then given by:

where the products were over all fragment alignments R and transcripts T in the transcriptome, and I t (r) was the implied length of a fragment determined by a pair of reads assuming it originated from transcript t ( Supplementary Fig. 2 ). This is the likelihood function for a linear model, and therefore, assuming the model was identifiable, the likelihood function had a unique maximum, which our implementation calculated via a numerical optimization procedure. Rather than reporting this estimate, we instead found the MAP estimate using a Bayesian inference procedure based on importance sampling from the posterior distribution. The proposal distribution we used was multivariate normal with mean given by the maximum likelihood estimate discussed above, and variance-covariance matrix given by the inverse of the observed Fisher information matrix. The samples were also used to compute 95% confidence intervals for the maximum a posteriori (MAP) estimates. The MAP estimates and (and associated confidence intervals) were used for differential expression testing.

Abundances were reported in FPKM (expected fragments per kilobase of transcript per million fragments sequenced). This unit is a scalar multiple of the parameters ρ t . FPKM is conceptually analogous to the reads per kilobase per million reads sequenced (RPKM) measure, but it explicitly accommodates sequencing data with one, two, or – if needed for future sequencing platforms – higher numbers of reads from single source molecules.

Abundance estimates were validated using spike-in sequences ( Supplementary Fig. 3 ) and simulations ( Supplementary Fig. 4 ). In order to confirm that all transcripts of a gene are necessary for accurate abundance estimation, novel transcripts were removed from the analysis ( Supplementary Fig. 5 ) showing that resulting estimates may be biased.

Transcripts were assembled from the mapped fragments sorted by reference position. Fragments were first divided into non-overlapping loci, and each locus was assembled independently of the others using the Cufflinks assembler. The assembler was designed to find the minimal number of transcripts that “explain” the reads (i.e. every read should be contained in some transcript). First erroneous spliced alignments or reads from incompletely spliced RNAs were filtered out. The algorithm for assembly was based on a constructive proof of Dilworth's Theorem (see Supplementary Methods, Appendix A, Theorem 17 ). Each fragment alignment was assigned a node in an “overlap graph” G . A directed edge ( x , y ) was placed between nodes x and y when the alignment for x started at a lower coordinate than y , the alignments overlapped in the genome, and the fragments were “compatible” ( Supplementary Fig. 6 ). Compatibility was defined for overlapping fragments for which every implied intron in one fragment matched an identical implied intron in the other fragment. The resulting directed, acyclic graph was transitively reduced to produce G , to avoid including redundant path information. Cufflinks then found a minimum path cover of G , meaning that every fragment node was contained in some path in the cover, and the cover contained as few paths as possible. Each path in the cover corresponded to a set of mutually compatible fragments overlapping each other on the left and right (except initial and terminal fragments on the path). Dilworth's theorem implied that this path cover could be constructed by first finding the largest set of fragments with the property that no two are compatible. This set was determined by finding a maximum matching in a bipartite graph constructed from the transitive closure of G . The bipartite “reachability graph” had a node in each partition for all fragments in G , and nodes were connected if there was a path between them in G . Given a maximum cardinality matching M , any fragment without an incident edge in M was a member of an antichain . Each member of this antichain could be extended to a path, and this extension was a minimum path cover of G .

The minimum cardinality chain decomposition computed using the approach above was not guaranteed to be unique. In order to “phase” distant exons, we leveraged the fact that abundance inhomogeneities could link distant exons via their coverage. We therefore weighted the edges of the bipartite reachability graph based on the percent-spliced-in metric introduced by Wang et al. 4 Cufflinks arbitrated between multiple parsimonious assemblies by choosing the minimum-cost maximum matching in the reachability graph. In our setting, the percent- spliced-in ψ x for an alignment x was computed by counting the alignments overlapping x in the genome that were compatible with x and dividing by the total number of alignments that overlap x , and normalizing for the length of the x . The cost C(y, z) assigned to an edge between alignments y and z reflected the belief that they originated from different transcripts:

A useful feature of the Cufflinks assemblies is that they resulted in provably identifiable models. Complete details of the Cufflinks assembler are provided in the Supplementary Material (Section 4) , along with proofs of several key theorems.

To validate Cufflinks transfrags (assembled transcript fragments) against annotated transcriptomes, and also to find transfrags common to multiple assemblies, we developed a tool called “Cuffcompare” that builds structural equivalence classes of transcripts. We ran Cuffcompare on the assembly from each time point against the combined annotated transcriptomes of UCSC, Ensembl, and Vega ( Supplementary Fig. 7 ). Because of the stochastic nature of sequencing, assembly of the same transcript in two different samples may result in transfrags of slightly different lengths. A Cufflinks transfrag was considered a complete match when there was a transcript with an identical chain of introns in the combined annotation. When no complete match was found between a Cufflinks transfrag and the transcripts in the combined annotation, Cuffcompare determined and reported if another potentially significant relationship existed with any of the annotation transcripts that could be found in or around the same genomic locus.

A total of 61,787,833 cDNA fragments were sequenced at 60 hours. We mapped and assembled subsets of these fragments (at fractions 1/64, 1/32, 1/16, 1/8, 1/4, and 1/2 of the total) using TopHat and Cufflinks.

Each assembly of parts of the data was compared to the assembly obtained with the full fragment set using Cuffcompare. We counted transcripts recovered in assemblies from partial data that structurally matched some transcripts in the assembly using all the reads. We assessed robustness of abundance estimation by counting the fraction of assembled transcripts that were assigned abundances within 15% of the FPKM value reported for the full fragment set transcript.

To assess the accuracy of Cufflinks' estimates, we simulated an RNA-Seq experiment using the FluxSimulator 27 , a freely available software package that models whole transcriptome sequencing experiments with the Illumina Genome Analyzer. The software works by first randomly assigning expression values to the transcripts provided by the user, constructing an amplified, size-selected library, and sequencing it. Mouse UCSC transcripts were supplied to the software, along with build 37.1 of the genome. FluxSimulator then randomly assigned expression levels to 18,935 UCSC transcripts. From these relative expression levels, the software constructed an in silico RNA-Seq sample, with each transcript assigned a number of library molecules according to its abundance. FluxSimulator produced 13,203,516 75bp paired-end RNA-Seq reads from 6,601,805 library fragments, which were mapped with TopHat to the mouse genome using identical parameters to those used to map the C2C12 reads. A total of 6,176,961 fragments were mapped (93% of the library). These alignments were supplied along with the exact set of expressed transcripts to Cufflinks, to measure Cufflinks' abundance estimation accuracy when working with a “perfect” assembly.

Transcripts with 5′ exons not in UCSC, Ensembl, or VEGA were selected for validation. We excluded transcripts with estimated abundances less than 5.0 FPKM at all time points, as well as transcripts with a 5′ exon within 200bp of an annotated exon. To validate our novel observed 5′ exons, we conducted ChIP-Seq experiments as previously described 28 at -24 and 60 hour time points using an antibody to the unphosphorylated CTD-repeat of RNA polymerase II (8WG16, Covance) as well as an antibody to TAF1 (SC-735, Santa Cruz) which marks promoters. For each candidate 5′end, we took the region +/- 200 bp and measured the normalized read density (RPKM) of each ChIP-Seq, requiring at least 1.5 RPKM of ChIP-Seq signal for both polymerase and TAF1 at either time point.

Six genes with multiple assembled splice isoforms were chosen as cases for endpoint PCR validation, including three with novel isoforms ( Supplementary Figs. 8,9 ). Amplification primers that cross the Cufflinks predicted spliced-exon junctions were purchased from Integrated DNA Technologies, Inc. (San Diego, CA). 5 ugs of total RNA from each time point was primed with oligodT(20) (Invitrogen catalog# 18418020), and reverse-transcribed at 50C using SuperScript III reverse transcriptase, (Invitrogen catalog # 18080044) according to the manufacturer's protocol. One tenth of the cDNA reaction was used as template for 35 rounds of PCR amplification with each pair of junction-crossing primers. The PCR reactions were cleaned up using the Qiaquick PCR cleanup kit (Qiagen catalog# 28104), and quantified using a Nanodrop spectrophotometer. An equal mass of DNA from each reaction (50 ngs) was then loaded in each lane of a 2.0% agarose gel, post-stained with Sybr Gold (Invitrogen Catalog # S11494) and visualized on a UV transilluminator.

In order to test for divergent expression dynamics among isoforms, we tested all high-confidence isoforms for significant changes between each time point using the abundance variance estimates produced by our statistical model (FDR < 5%). Trajectories were assigned to transcript expression curves based on significant (FDR<5%) increases or decreases in expression between consecutive time points. To be deemed significant, expression between consecutive time points also had to change by at least 25%. The possible trajectories were therefore reduced to 81 combinatorial possibilities (increasing, decreasing or flat between any of the three pairs of consecutive time points). Trajectories were then classified into 4 groups: increasing (3 consecutive increases), decreasing (3 consecutive decreases), flat (no changes) and mixed (presence of both increases and decreases in expression along the time course). To test for significant changes in relative abundance a group of transcripts, we calculated the square root of the Jensen-Shannon divergence on the relative abundances in each of two time points. The variance of this metric under the null hypothesis of no change in relative abundance can be estimated using the delta method from the variance-covariance matrix on abundances estimates. Using the estimated variance of the JS metric, we applied a one-sided t-test for significant changes in relative abundance of transcripts grouped by TSS and also primary transcripts grouped by gene. Type I errors were controlled with the Benjamini-Hochberg correction for multiple testing of differential expression, splicing, and promoter preference throughout the analysis. Supplementary Figs. 10,11 show examples of genes with significant changes in relative transcript abundances during the time-course.

TopHat is freely available as source code at http://tophat.cbcb.umd.edu . It takes a reference genome (as a Bowtie 29 index) and RNA-Seq reads as FASTA or FASTQ and produces alignments in SAM 30 format. TopHat is distributed under the Artistic License and runs on Linux and Mac OS X.

The Cufflinks assembler and abundance estimation algorithms are open-source C++ programs and are freely available in both source and binary at http://cufflinks.cbcb.umd.edu/ . The package includes the assembler along with utilities to structurally compare Cufflinks output between samples (Cuffcompare) and to perform differential expression testing (Cuffdiff). Cufflinks is distributed under the Boost License and runs on Linux and Mac OS X. The source code for Cufflinks version 0.8.0 is provided in Supplementary File 3 .