# Title
Diffeomorphic registration using geodesic shooting and Gauss–Newton optimisation

# Abstract
This paper presents a nonlinear image registration algorithm based on the setting of Large Deformation Diffeomorphic Metric Mapping (LDDMM), but with a more efficient optimisation scheme — both in terms of memory required and the number of iterations required to reach convergence. Rather than perform a variational optimisation on a series of velocity fields, the algorithm is formulated to use a geodesic shooting procedure, so that only an initial velocity is estimated. A Gauss–Newton optimisation strategy is used to achieve faster convergence. The algorithm was evaluated using freely available manually labelled datasets, and found to compare favourably with other inter-subject registration algorithms evaluated using the same data.

## Introduction
This paper is about nonlinear image registration, which primarily aims to align images of different subjects, although it may also be of use for aligning longitudinal data of the same subject in situations where shape changes may have occurred. Inter-subject registration enables findings from functional imaging studies of different subjects to be brought within a common anatomical space, via a procedure known as “spatial normalisation”. In addition to this role, accurate alignment across subjects has many other applications, particularly in areas of translational science. Accurate registration allows information derived from some subjects (possibly from data that can only be collected post-mortem) to be generalised to the anatomy of other individuals.

Unfortunately, it is commonplace to find neuroimagers still using relatively old and inaccurate inter-subject registration techniques ( Klein et al., 2009 ), which preclude accurate localisation of findings from multiple subjects. This may be because of a commonly held belief that brain anatomy is not predictive of brain function. There is increasing evidence emerging that shows this argument to be incorrect, and that by aligning anatomical features, such as cortical folds, we are able to also align functionality homologous areas. Relatively recent advances show that information from anatomical scans (such as T1-weighted MRI) do allow the underlying cyto-architecture to be predicted from folding patterns of the cortex ( Fischl et al., 2008; Yeo et al., 2007 ). These studies were carried out by aligning cortical surfaces, and not by volumetric registration procedures. Evaluations based on manually traced structures show that nonlinear volumetric registration algorithms can be much more accurate than simple affine registration ( Klein et al., 2009 ), although it still remains to be seen how well the most advanced volumetric registration methods can align cyto-architectonic borders. Klein et al. (2010) also showed that volumetric registration gave similar accuracy to cortical alignment approaches, although a more recent paper ( Ghosh et al., 2010 ) showed higher accuracy for surface-based methods in some situations. The evaluations in the current paper will use some of the same dataset used by Klein et al. (2009) , and are based on an assumption that manually drawn labels are accurate enough to be used as “ground truth”. Any gains in accuracy should be of benefit in terms of achieving greater overlap of functionally specialised brain regions across subjects. In addition to improved regional specificity to whatever measure is of interest, more accurate alignment should also provide increased sensitivity, with less need to spatially blur images in order to superimpose features.

Image registration models also play a useful role in geometric morphometrics, as registration essentially involves learning a model of the relative shapes of the organs or organisms under study. Shape, or form, may be encoded in numerous ways, some of which are more parsimonious than others. Under the assumption that measurements such as length, area and volume should all be positive, diffeomorphic registration approaches are able to encode relative shapes using the powerful initial momentum formulation ( Wang et al., 2007; Younes, 2007 ). The decreasing cost of gene sequencing, along with a trend to assemble large datasets of scans, is likely to lead to renewed interest in modelling inter-subject variability. As outlined in Ashburner and Klöppel (2010) , much of the inter-subject variance among brain images is dealt with by shape modelling (computational anatomy).

Any conclusions drawn from a study depend on how the data are modelled. In the case of computational anatomy studies, the accuracy of inter-subject registration plays a significant role in terms of the actual findings obtained, as well as on the interpretability of those findings. It is therefore worth ensuring that an accurate and coherent model of the data is used, before attempting to draw a conclusion from the fitted model. From a theoretical perspective, the state-of-the-art in terms of formulating volumetric image registration, in a mathematically coherent way, is probably the Large Deformation Diffeomorphic Metric Mapping (LDDMM) of Beg et al. (2005) .

Most image registration methods are based on a small-deformation approximation, which attempts to represent relative shapes in terms of displacement fields. Such models assume that displacements may be added and subtracted in a linear way, rather than by correctly composing deformations. Assumptions of linearity result in a number of problems (one-to-one mappings break down, lack of inverse consistency, etc), which are generally either ignored, or fixed using ad hoc procedures. The LDDMM framework resolves these limitations, at source, by using a more coherent formulation of the registration model. Instead of incorrectly assuming linearity, the formulation incorporates established techniques from the fields of differential geometry and mechanics.

Another commonly used framework is the one known as “viscous-fluid modelling” ( Christensen et al., 1996 ), which does not have a clearly defined objective function, thus precluding a probabilistic interpretation of the model. This is likely to limit its long term applicability.

This paper builds on LDDMM, but includes some additional components that are intended to enable more efficient registration, both in terms of the number of iterations needed to achieve convergence and also the amount of memory required for encoding the deformations. Although over the longer term, processing speed will become much less important than accuracy, it is still worth trying to achieve equally accurate results as efficiently as possible.

## Methods
In the current work, image registration is treated as an optimisation problem, which involves minimising an objective function consisting of the sum of two terms.

The first term is a measure of how much the template is distorted in order to match the individual's image. Because deformations do not add and subtract linearly, it is not optimal to measure the magnitude of a deformation based on some linear measure computed from a single displacement field. Such small-deformation approximation approaches are commonly used, but they do not give consistent measures of deformation magnitude between forward and inverse deformations. The magnitude of a deformation is better computed as a geodesic distance, using ∫ t = 0 1 || Lv t || dt , where L is a linear operator, which operates on a time-dependent velocity that mediates the deformation over unit time. In practice, the registration is regularised by penalising the “energy” in the deformation ( 1 2 ∫ t = 0 1 | | L v t | | 2 d t ), where L determines the nature of the energy (based on beliefs about what sorts of deformations are more probable a priori ). Occasionally, the literature refers to velocities where each point in the time varying velocity field ( v t ) is associated with the same point in the underlying image. This is not the case here, as v t is the Eulerian speed vector field, defined over the ambient space through which the deforming image passes.

The second term is a measure of how closely the images appear to be aligned, and is typically one of the usual cost functions used for image registration, such as the mean squared difference between a subject's image ( f ) and a deformed version of the template ( μ ( φ 1 − 1 )). Here, φ is a diffeomorphic mapping (diffeomorphism) encoding the deformation. With this image matching term, the algorithm minimises the following: (1) E = 1 2 ∫ t = 0 1 | | L v t | | 2 d t + 1 2 σ 2 | | f − μ φ 1 − 1 | | 2 , where φ 0 = Id , d φ d t = v t φ t

Computing a diffeomorphic deformation is treated as modelling a dynamical system, which evolves over unit time. Subscripts on v and φ indicate velocity fields and diffeomorphisms at different time points. The easiest way to conceptualise the evolution is in terms of an Euler integration, in which case the diffeomorphism ( φ 1 ) and its inverse ( ϑ 1 ) are computed from the compositions of series of small-deformations. From this perspective, a series of N velocity fields are used to represent the time varying velocity field. For N uniformly spaced time steps (0, t 1 , t 2 ,..., t N − 2 , t N − 1 ), computing the diffeomorphisms may be achieved by: (2) φ 1 = Id + 1 N v t N − 1 ∘ Id + 1 N v t N − 2 ∘ ... ∘ Id + 1 N v t 1 ∘ Id + 1 N v 0 (3) ϑ 1 = Id − 1 N v 0 ∘ Id − 1 N v t 1 ∘ ... ∘ Id − 1 N v t N − 2 ∘ Id − 1 N v t N − 1

Providing all the small-deformations are sufficiently small to be one-to-one (and satisfy certain smoothness criteria), their compositions should also result in one-to-one mappings ( Christensen et al., 1995 ). More sophisticated integration methods (than Euler) yield more accurate results using fewer time steps, but are not explored here. It should also be pointed out that care should be taken with the compositions, particularly when interpolating deformation fields close to boundaries. In most situations, it is more efficient to use φ + 1 N v t ∘ φ instead of Id + 1 N v t ∘ φ .

Beg et al. (2005) describe registration in terms of a variational optimisation of this sequence of velocity fields, using a gradient descent scheme. This approach has two main disadvantages. 1. The entire sequence of velocity fields needs to be retained, either in memory or on disk, which can make the approach quite demanding in terms of memory requirements. 2. Gradient descent optimisation is slow, and requires many iterations to reach satisfactory convergence.

The entire sequence of velocity fields needs to be retained, either in memory or on disk, which can make the approach quite demanding in terms of memory requirements.

Gradient descent optimisation is slow, and requires many iterations to reach satisfactory convergence.

Instead of using a variational scheme to estimate a series of velocity fields, the aim of the optimisation in the current work is to determine only an initial velocity field ( v 0 ). Forward and backward deformations ( φ and ϑ ) may then be computed from the initial velocity, using a geodesic shooting scheme. The use of GS negates the need to store the entire series of velocity fields, thus reducing memory and disk space requirements. The reason this works is that the principle of stationary action uniquely determines the trajectory of the deformation, given the initial velocity. Furthermore, because (kinetic) energy is conserved, we only need to evaluate the energy for this initial velocity. A related scheme has already been devised by Marsland and McLachlan (2007) , who parameterised two-dimensional deformations using 21 control points. Registration then involved estimating the 42 parameters that encode the initial momenta of these points. As pointed out by Marsland, his framework is too computationally expensive to use many control points and therefore not practical for the six million or so parameters that we use to represent relative shapes. A similar framework for optimising initial momentum was also presented in Cotter and Holm (2006) , but involved a particle mesh method that overcomes many of the computational problems of using control points. The work presented here shares a great deal with that in Cotter and Holm (2006) (neither requires the entire sequence of velocity fields to be stored), and is essentially a Gauss–Newton implementation of that approach.

In the current work, registration is treated as a nonlinear optimisation problem, where the aim is to determine the optimal values for the coefficients parameterising a discretised version of the initial velocity field. Because it is nonlinear and has no closed-form solution, it requires an iterative approach to solve. We use a Gauss–Newton optimisation scheme, which uses approximations to both first and second derivatives and usually achieves convergence in fewer iterations than an approach using only first derivatives.

The next section describes geodesic shooting, and this is followed by a section describing the optimisation scheme.

Beg's algorithm may be conceptualised within the framework of the principle of stationary action , which is a variational principle that may be used for obtaining equations of motion. Within this framework, L † L may be considered as a model of the “inertia” of the system, such that the “kinetic energy” of the evolving system is given by 1 2 v t , L † L v t . Similarly, there is a concept of momentum, given by u t = L † Lv t . Velocity may be derived from momentum by smoothing with K , which is the inverse of the L † L operator. In other words, KL † Lv = v and L † LKu = u . Given an initial and final configuration (ie an identity transform and the final deformation respectively) at each iteration, Beg's algorithm determines the series of intermediate configurations that have the least kinetic energy. In practice it is a little more complicated than that, as the estimation of the final configuration is not really separated from the estimation of the intermediate configurations. The solution obtained by LDDMM satisfies the condition that the derivatives of the objective function with respect to changes in the velocity are zero. These derivatives were derived in Beg et al. (2005) , and a simpler derivation was also given in the appendix of Ashburner (2007) . This solution obeys the following Euler–Lagrange equation (Eq. (9) of Beg et al. (2005) ), where the D operator refers to computing the Jacobian tensor: (4) v t + K 1 σ 2 | D ( φ 1 ∘ φ t − 1 ) | ( ∇ ( μ ∘ φ t − 1 ) ) ( f ∘ φ 1 ∘ φ t − 1 − μ ∘ φ t − 1 ) = 0

The foregoing equation shows that, at the solution, the velocity at each time point may be derived from the initial velocity. The gradients of the warped template ∇ ( μ ∘ φ t − 1 ) may also be computed by warping the gradients of the template and multiplying by the transpose of the Jacobian tensor at each point ( D φ t − 1 ) T ((∇ μ ) ∘ φ t − 1 ). Also, the Jacobian determinants of the composed transformations | D ( φ 1 ∘ φ t − 1 )| may by computed by (| D φ 1 | ∘ φ t − 1 )| D φ t − 1 |. This leads to the following re-arrangement of Eq. (4) : (5) v t = K | D φ t − 1 | ( D φ t − 1 ) T 1 σ 2 | ( D φ 1 | ( ∇ μ ) ( μ − f ∘ φ 1 ) ∘ φ t − 1

At time zero, φ 0 is the identity transform, so the initial momentum is: (6) u 0 = L † L v 0 = 1 σ 2 | D φ 1 | ( ∇ μ ) ( μ − f ∘ φ 1 )

Combining Eqs. (5) and (6) shows that the velocity at any time is given by the initial velocity or momentum: (7) v t = K | D φ t − 1 | ( D φ t − 1 ) T ( u 0 ∘ φ t − 1 )

This conservation of momentum is well known and leads to an alternative approach, which is to formulate each iteration of the registration as an initial value problem. Here, the intermediate configurations, and therefore the final deformation, are all computed from the initial conditions. These initial conditions are the spatial configuration (an identity transform) and the initial velocity or momentum. This procedure is known as geodesic shooting (GS), and may be viewed as an integration based on Hamilton's equations. More complete explanations of the mathematics underlying the GS approach are to be found in the literature ( Miller et al., 2006; Cotter and Holm, 2006; Marsland and McLachlan, 2007; Younes, 2007; Younes et al., 2008, 2009 ) or in various textbooks ( Younes, 2010; Holm et al., 2009; Grenander and Miller, 2007 ). This section will simply outline how a deformation and its inverse may be computed from an initial velocity field, by Euler integration.

Geodesic shooting requires the initial momentum ( u 0 ), which is derived from the initial velocity by applying L † L . (8) u 0 = L † L v 0

The inverse (backward) deformations are initialised to the identity and, if required, their Jacobian tensor fields are set to an identity matrix at each point. Here, the D operator is used to denote computing the Jacobian tensor at each point in the image. In this case, the Jacobian tensors from an identity transform are all identity matrices. (9) ϑ 0 = Id , J 0 ϑ = D ϑ 0

If required, the forward deformation is also initialised to an identity transform, and possibly also its Jacobian tensor field. (10) φ 0 = Id , J 0 φ = D φ 0

Then the following (Eqs. (11) to (16) ) are executed for each of N time steps. For the n th time step, the backward deformation is incremented by composing it with a small-deformation. (11) ϑ t n = ϑ t n − 1 ∘ Id − 1 N v t n − 1

This procedure requires the Jacobians of this deformation. These may be constructed from the sequential composition of the Jacobians of the small-deformations, but may also be derived by computing the gradients of ϑ t n − 1 . The procedure involves matrix multiplications with the 3 × 3 Jacobian tensors at each point. (12) J t n ϑ = J t n − 1 ϑ ∘ Id − 1 N v t n − 1 T D Id − 1 N v t n − 1

A forward deformation and its Jacobian tensor field may be required, but it is not strictly necessary for the integration. (13) φ t n = Id + 1 N v t n − 1 ∘ φ t n − 1 (14) J t n φ = D Id + 1 N v t n − 1 ∘ φ t n − 1 T J t n − 1 φ

The velocity field is updated, by first generating a view of the momentum, which accounts for the current deformation. (15) u t n = | J t n ϑ | J t n ϑ T u 0 ∘ ϑ t n

Velocity is then obtained from the momentum by applying the K operator. Fourier transform methods may be used to effect this convolution, but other approaches, such as the multi-grid methods used in the current paper, are also possible. (16) v t n = K u t n

The registration algorithms described in this paper use an alternative integration scheme, which is now presented. Rather than transforming the initial momentum using ϑ t with a pullback scheme, it uses φ t with a push-forward. It is therefore more suited to the direct computation of φ 1 from v 0 .

The procedure begins by computing the initial momentum from its velocity (Eq. (8) ), and setting the forward deformation and its Jacobian tensor field to identity transforms (Eq. (10) ). Then the following (Eqs. (17) to (20) ) are computed for each of the N time steps.

Update the forward deformation using Eq. (13) . (17) φ t n = Id + 1 N v t n − 1 ∘ φ t n − 1

In this integration strategy, the inverses of the Jacobian matrices at each point will be used. If relatively few time steps are used, the possibility of small-deformations containing Jacobians with zero or negative determinants becomes more likely. To increase stability, the computation of the Jacobian tensor field is therefore modified slightly, replacing the small-deformation approximation of the Jacobians by the matrix exponentials (eg, see Moler and Van Loan (2003) ) of the gradients at each point of the velocity field. The use of matrix exponentials is to ensure that the Jacobians are invertable (by preventing their determinants from approaching zero), even though the small-deformation itself may not have positive Jacobian determinants. (18) J t n φ = Exp 1 N D v t n − 1 ∘ φ t n − 1 T J t n − 1 φ

Obtaining the new view of the momentum involves a push-forward scheme. This will be denoted by φ ⁎ u , and involves adding each of the voxels in u into the appropriate positions of the warped version. The end result is similar to | J φ − 1 | u ∘ φ − 1 , but contains some aliasing effects. (19) u t n = φ t n ⁎ J t n φ − 1 T u 0

The final procedure within each time step is to update the velocity (Eq. (16) ). (20) v t n = K u t n

In this work, registration is viewed as an optimisation procedure, where the objective is to estimate the initial velocity field, parameterising the diffeomorphism that best aligns the images. An optimisation scheme based on using approximations to both first and second derivatives is presented. It will be described for a matching term based on the sum of squares difference, but other objective functions may also be used.

Conservation of “kinetic energy” allows the registration objective function to be formulated as: (21) E = E 1 + E 2 = 1 2 | | L v 0 | | 2 + 1 2 σ 2 ∫ x ∈ Ω f ( x ) − μ ( φ 1 − 1 ( x ) ) 2 d x

This objective function can be re-written as the difference between the template and warped image, by including a change of variables to account for expansion and contraction. (22) E = 1 2 | | L v 0 | | 2 + 1 2 σ 2 ∫ x ∈ Ω | J 1 φ ( x ) | f ( φ 1 ( x ) ) − μ ( x ) 2 d x

For each iteration of LDDMM, all the relevant deformations ( ϑ t n and φ 1 ) are computed from the current estimates of the velocity fields ( v t n iter ), and then the velocity fields are updated by a descent step (scaled by ε ) along the, so called, Hilbert gradient. Briefly, the Hilbert gradient may be considered as the derivatives of the objective function with respect to variations in the velocity, if this velocity were parameterised by a linear combination of Green's functions similar to those shown in Fig. 1 . Without including the K operator in the update equations (to give the Hilbert gradient), the gradient descent would be much less stable. In the following update equation, the multiplications by J t n ϑ T account for the changes to the template gradients as it is warped over time (see later). Similarly, Jacobian determinants are included because of the change of variables needed to account for expansion or contraction of the individual image. The following gradient descent step is simply a re-expression of Eqs. (10) and (12) of Beg et al. (2005) . (23) v t n i t e r + 1 = v t n iter − ε K L † L v t n iter + | J t n ϑ | ( J t n ϑ ) T | J 1 φ | σ 2 ( f ∘ φ 1 − μ ) ∇ μ ∘ ϑ t n

This procedure, which involves alternating between updating all the deformations, and updating all the velocities, is repeated until convergence or until some limit on the number of iterations is reached.

Differentiating φ 1 with respect to variations in v 0 is not straightforward, when it is computed via GS. This leads to difficulties in computing the exact derivatives needed for Gauss–Newton optimisation. Therefore, an alternative strategy is adopted. First of all though, the principles of how the initial velocity could be optimised using gradient descent will be illustrated. Simplifying Eq. (23) for the special case of the initial velocity gives the following gradient descent step. (24) v 0 i t e r + 1 = v 0 iter − ε K L † L v 0 iter + | J 1 φ | σ 2 ( f ∘ φ 1 − μ ) ∇ μ

In essence, the LDDMM algorithm ( Beg et al., 2005 ) updates v 0 using Eq. (24) , and would normally proceed to update the remaining velocity fields using Eq. (23) . However, rather than updating the remaining fields by gradient descent, they could instead be updated by shooting from v 0 . This is a similar procedure to that employed in Cotter and Holm (2006) and Marsland and McLachlan (2007) . Providing the gradient descent step on the initial velocity brings it closer to its optimal solution, the updates of the remaining velocity fields should also be brought closer to their optima.

The Gauss–Newton approach is now described, which uses both first and second derivatives. To make the problem tractable, at each iteration the update can be conceptualised as estimating a small displacement field ( s ) that would improve the objective function. The estimated displacement is treated as an increment to the initial velocity, which is then used to update the deformation via geodesic shooting. Deriving the first and second derivatives necessary for each iteration of this approach involves differentiating the following (around s = 0 ), with respect to variations in s (while holding v 0 and φ 1 fixed): (25) E = 1 2 | | L ( v 0 + s ) | | 2 | s = 0 + 1 2 σ 2 ∫ x ∈ Ω | J 1 φ ( x ) | f ( φ 1 ( x ) ) − μ ( x − s ( x ) ) 2 d x | s = 0

Because it is often easier to discretise the problem prior to optimising, the descriptions in the remainder of this section will use a discrete formulation. The initial velocities are now represented as a linear combination of trilinear interpolation basis functions. The value of each point ( x ) in the continuous vector field ( v 0 ( x ) ) is encoded by ∑ i = 1 I w i b i ( x ) , where b i ( x ) is the i th basis function. Similarly, s ( x ) in Eq. (25) is parameterised the same way. The registration involves estimating the vector of I coefficients w . Within the discrete setting, 1 2 | | L v 0 | | 2 may be computed by 1 2 w T A w , where A is a very large sparse matrix encoding the operator L † L . See, for example, Modersitzki (2009) for further details about how such operators may be formulated as matrices. Within this discrete setting, the gradient descent update in Eq. (24) may be expressed as: (26) w i t e r + 1 = w iter − ε A − 1 A w iter + g iter

For the 3D case, the vector of first derivatives may be written in terms of its three components as: (27) g = g ( 1 ) g ( 2 ) g ( 3 )

The velocity is parameterised using trilinear interpolation basis functions, so using ∇ l to indicate the gradient along the l th dimension, the components of the derivatives are computed by: (28) g i ( l ) = d E 2 d w i = 1 σ 2 J 1 φ x i f φ 1 x i − μ x i ∇ l μ ∘ x i

Convergence of gradient descent algorithms is often much slower than that of algorithms that also use second derivatives. By including an approximation of the Hessian of E 2 within the optimisation, it is possible to make the update steps more effective. Including the Hessian ( H ) to obtain a Gauss-Newton optimisation involves a slight change to Eq. (26) . (29) w i t e r + 1 = w iter − γ A + H iter − 1 A w iter + g iter

The foregoing equation is a slightly modified version of the pure Gauss–Newton update formula, as it includes a scaling parameter ( γ ), which may be used to prevent updates from overshooting. For a pure Gauss–Newton approach, γ would be set to 1, but there may be situations where its value should be decreased. For example, after an iteration in which the objective function gets worse, it can be a good idea to halve the value of γ . This situation can occur with the diffeomorphic registration procedure, but it also happens when optimising small-deformation registration models.

Instead of the true Hessian (of Eq. (25) ), a positive semi-definite approximation is used, that ignores derivatives of the template that are higher than first order (see eg Modersitzki (2009) ). Just as the first derivatives ( g ) may be computed by differentiating Eq. (25) around s = 0 , so the Hessian ( H ) may be computed in a similar way. Again, because the velocity field is modelled using trilinear interpolation, these second derivatives of E 2 (based on Eq. (25) ) have the following form: (30) H = diag h ( 11 ) diag h ( 12 ) diag h ( 13 ) diag h ( 12 ) diag h ( 22 ) diag h ( 23 ) diag h ( 13 ) diag h ( 23 ) diag h ( 33 ) where: (31) h i ( l m ) = 1 σ 2 | J 1 φ ( x i ) | ( ( ∇ l μ ) ∘ x i ) ( ( ∇ m μ ) ∘ x i )

The overall algorithm is summarised as follows. • Set the initial velocity v 0 (parameterised by w ) to zero, and γ to 1. • Repeat the following until convergence or for a fixed number of iterations - Shoot from the initial velocity v 0 to obtain φ 1 . - Compute the objective function, and approximate gradient and Hessian ( E , g and H ), using the current φ 1 . These are in Eqs. (22), (27) and (30) . - If E is worse than that from the previous iteration, decrease γ . - The coefficients, which parameterise v 0 , are updated using Eq. (29) .

Set the initial velocity v 0 (parameterised by w ) to zero, and γ to 1.

Repeat the following until convergence or for a fixed number of iterations - Shoot from the initial velocity v 0 to obtain φ 1 . - Compute the objective function, and approximate gradient and Hessian ( E , g and H ), using the current φ 1 . These are in Eqs. (22), (27) and (30) . - If E is worse than that from the previous iteration, decrease γ . - The coefficients, which parameterise v 0 , are updated using Eq. (29) .

Shoot from the initial velocity v 0 to obtain φ 1 .

Compute the objective function, and approximate gradient and Hessian ( E , g and H ), using the current φ 1 . These are in Eqs. (22), (27) and (30) .

If E is worse than that from the previous iteration, decrease γ .

The coefficients, which parameterise v 0 , are updated using Eq. (29) .

The Gauss–Newton updates involve very large sparse matrices. Various numerical optimisation techniques may be used for computing H + A − 1 g + A w , many of which are outlined by Modersitzki (2009) . A multi-grid approach was used for the work described in this paper, which was the same implementation as used in Ashburner (2007) .

## Results and discussion
This paper is concerned with increasing the efficiency of LDDMM, and focuses on one aspect of image registration. The aim here is simply to demonstrate some of the desirable properties of the algorithm, and to assess the accuracy of the resulting image alignment. A two-dimensional toy example is provided next, which illustrates some of the properties of the resulting deformations. This is followed by an evaluation of the label propagation accuracy obtained when the algorithm is applied to real three-dimensional brain images. Then there is an illustration of the rate of convergence with real three-dimensional data, which is followed by the final section demonstrating some of the invariance properties of the GS formulation.

Two simulated two-dimensional images (128 × 128 pixels) were registered together to illustrate the underlying principles. An image containing two concentric circles was used as the template ( μ ), and the target ( f ) was an image of a more complex shape (shown in Fig. 2 ). The objective function was the sum of squares difference between the target and warped template images, and the operator ( L † L ) encoded linear elasticity (as used by Christensen et al. (1996) ). The boundary conditions were circulant, and the Euler integration used 20 time steps. To illustrate the effectiveness of the Gauss–Newton approach, Fig. 3 shows a plot of the objective function with each iteration. For this example, a reasonably accurate solution is achieved within about 20 to 30 iterations.

Fig. 4 illustrates the evolution equations that construct diffeomorphic deformations from an initial velocity or momentum field. The first column shows the template as it is deformed over time ( μ ∘ ϑ t n ), and its horizontal and vertical spatial gradients (∇ ( μ ∘ ϑ t n ), which may also be computed by ( J t n ϑ ) T ( ( ∇ μ ) ∘ ϑ t n ) ). This is followed by a column of residual images, constructed from 1 σ 2 | J t n ϑ | ( ( | J 1 φ | ( μ − f ∘ φ 1 ) ) ∘ ϑ t n ) . Next is the momentum at different time points, which may be constructed by multiplying the warped residuals by the gradients of the warped template. Obtaining the velocity fields ( v ) from the momentum is by applying K (Eqs. (16) or (20) ), which is essentially a convolution with the function shown in Fig. 1 . These time varying velocity fields are shown in the next column. Updates to the backward and forward deformations may then be made by composing with small-deformations constructed using this velocity field (Eqs. (11) to (14) ). These deformations, along with their Jacobian determinants are shown in the final four columns.

The same 2D examples were also registered using some other approaches, with the aim of illustrating some of the limitations that are overcome using the diffeomorphic formulation. The first of these involved parameterising with a one-parameter subgroup, which allows diffeomorphic mappings to be constructed via a scaling and squaring procedure ( Arsigny et al., 2006; Ashburner, 2007; Arsigny et al., 2009 ). It was intended to serve as a fast approximation to the full diffeomorphic framework described in this work. An inverse consistent formulation was used, which involved minimising the following (32) E ops = 1 2 | | L v | | 2 + 1 4 σ 2 ∫ x ∈ Ω f ( x ) − μ ( χ − 1 ( x ) ) 2 d x + 1 4 σ 2 ∫ x ∈ Ω μ ( x ) − f χ x 2 d x where χ is computed by integrating χ̇ = v(χ) over unit time, after initially setting χ to an identity transform. The inverse ( χ − 1 ) may be computed by simply reversing the sign of v . Eight squaring steps were used, which corresponds to an Euler integration with 256 time steps. The same linear elasticity metric was used as a regulariser and also the same value of σ 2 . The results of this registration are presented in the left-hand panel of Fig. 5 , and show that the log-Euclidean approximation achieves a reasonably good overlap between the two images. The log-Euclidean approximation is unable to encode all possible diffeomorphic mappings (see page 456 of Kriegl and Michor (1997) ), so the model had to introduce additional distortions to achieve this overlap. This is particularly visible in the Jacobians when they are compared to those in Fig. 2 . It is readily apparent that the log-Euclidean approach does not localise volumetric differences as accurately as the shooting approach. This is likely to make the GS approach more suited to morphometric applications.

Two small-deformation models were also included (both using the same regularisation), the first of which involved warping the template to match the individual. The displacement field ( v ) was found that minimises (33) E s d 1 = 1 2 | | L v | | 2 + 1 2 σ 2 ∫ x ∈ Ω f ( x ) − μ ( x − v ( x ) ) 2 d x

Registration results from this model are presented in the centre panel of Fig. 5 and show that this model was unable to achieve a good overlap between the images. When compared with the results in Fig. 2 , it should be readily apparent that the inverse of a deformation cannot be achieved by negating a displacement field. This illustrates the fact that combined deformations cannot be computed accurately by simply adding or subtracting displacement fields, and therefore that the study of shapes cannot be optimally achieved using simple linear models. Another issue is that the resulting Jacobian determinants were not all positive, indicating that the one-to-one mapping has broken down and the deformations are not invertable. Negative Jacobian determinants also pose a problem for morphometric applications that involve working with logarithms of Jacobians. Also of note is the fact that the Jacobian determinants are not in alignment with the template image, which is another reason why this approach may be unsuited to morphometric applications.

The second small-deformation model involved warping the individual to the template, by minimising the following. (34) E s d 2 = 1 2 | | L v | | 2 + 1 2 σ 2 ∫ x ∈ Ω f ( x + v ( x ) ) − μ ( x ) 2 d x

This formulation of a small-deformation model is less correct from a generative modelling perspective, as it does not allow an image to be treated as a sample from the probability density encoded by the model. However, it is an approach that is commonly used for spatially normalising multiple images to the same template. The results of this model are illustrated in the right-hand panel of Fig. 5 , and again show that linear addition and subtraction of displacement fields is not appropriate. Also, some parts of the deformation fields had negative Jacobian determinants, which show the one-to-one mapping breaking down. The resulting deformation fields from Eq. (35) are more suited to some morphometric applications than those of (34) .

Fig. 6 shows the parameters of the various models, illustrating the fact that the shooting method aligns shape information with the template image. For morphometric applications, where images of multiple subjects are aligned to a common template, this alignment of information should lead to a more parsimonious representation when using approaches such as principal component analysis.

Evaluation was performed using similar procedures to those of Klein et al. (2009) , and involved two datasets that are publicly available. Although these datasets do not provide absolute ground truth, they do allow automated methods to be compared against human experts. All the subjects’ scans have manually defined labels associated with them, which enables a comparison between manual and automatic structure labelling. For each of the datasets, the procedure involved aligning all the MR scans together (without using knowledge of the structure labels), and assessing how close the alignment is by warping each subject's structure labels into alignment with each other subject's labels. Overlap measures are most meaningful when compared with those achieved by other approaches, so the reader is referred to Klein et al. (2009) for reports of the “target overlap” measures from 15 other inter-subject registration algorithms. The measure is defined by the volume over which the deformed source labels match the target labels, divided by the total volume of the target labels.

In the Klein paper, registration was done in a pairwise manner. In this evaluation, registration is between each individual in a dataset and the common average shaped template for that dataset. Rather than aligning the images themselves, the registration aligned tissue class data, and assumed that the tissue images of each subject are drawn from a multinomial distribution, whose mean is represented by a deformed version of the template ( Ashburner and Friston, 2009 ). For M tissue classes, over I voxels, the objective function to minimise for one image is: (35) E = 1 2 | | L v 0 | | 2 − ∑ i = 1 I | J 1 φ ( x i ) | ∑ m = 1 M f m ( φ 1 ( x i ) ) log μ m ( x i )

The tissue class images were automatically derived via the “new segmentation” algorithm in SPM8 ( Ashburner and Friston, 2005 ). Default settings were used for the tissue segmentation, except that a non-parametric representation of the tissue intensity distributions was used, rather than the default mixture of Gaussians. The tissue class images used for estimating the deformations were at an isotropic resolution of 1.5 mm.

Following tissue classification, the diffeomorphic registration was repeated using two different regularisation settings. 1 An elastic operator was used in both cases, as defined by: (36) | | L v | | 2 = ∫ x ∈ Ω λ 1 4 | | D v + ( D v ) T | | 2 + λ 2 | | tr ( D v ) | | 2 + λ 3 | | v | | 2 d x

The three hyper-parameters control the following: • λ 1 penalises the amount of stretching and shearing (but not rotation). • λ 2 controls the divergence of the initial velocity, which in turn determines the amount of volumetric expansion and contraction. • λ 3 simply penalises absolute displacements. It is included to ensure the uniqueness of the resulting K operator.

λ 1 penalises the amount of stretching and shearing (but not rotation).

λ 2 controls the divergence of the initial velocity, which in turn determines the amount of volumetric expansion and contraction.

λ 3 simply penalises absolute displacements. It is included to ensure the uniqueness of the resulting K operator.

The settings used were λ 1 = 1.0, λ 2 = 0.5, λ 3 = 0.001 (referred to as GS1 in the results tables) and λ 1 = 0.5, λ 2 = 1.0, λ 3 = 0.001 (called GS2).

A further set of registrations were also carried out, but using the one-parameter subgroup representation ( Arsigny et al., 2006, 2009 ) of Dartel ( Ashburner, 2007 ), rather than GS. The overall procedure was identical to GS2, except for the parameterisation of the deformations.

After registration, the results include a set of mappings from the template to each of the individuals. For the evaluation, mappings from each individual to each other individual were required, so that structure labels from each subject could be overlaid on images of all other subjects. These mappings were derived by composing the inverse of one mapping, with another mapping, and using the result to warp the structure labels from one subject into alignment with the anatomy of another.

The first of the datasets was from the Internet Brain Segmentation Repository (IBSR) provided by the Center for Morphometric Analysis at Massachusetts General Hospital. 2 They consist of 18 anonymised T1-weighted MR scans (subject, scanner and sequence information are unknown), on which 43 individual structures have been manually labelled. The registration was based on the simultaneous alignment of grey matter, white matter, CSF, bone and soft tissue.

The second dataset is from the LONI Probabilistic Brain Atlas (LPBA40) ( Shattuck et al., 2008 ) 3 and consists of 40 skull-stripped T1-weighted images (with cerebellum and brain-stem removed), that have 56 structures manually delineated. Because the LPBA40 set had been closely skull-stripped, this registration was based only on simultaneous alignment of grey and white matter.

The resulting target overlaps are shown in Fig. 7 , and compare favourably with the best overlap results of Klein et al. (2009) . For the IBSR18 dataset, the mean and median overlaps were 0.573 and 0.577 respectively for GS1, and 0.590 and 0.594 for GS2. Mean and median overlaps from the Dartel approach were 0.586 and 0.591. The greatest median overlap reported by Klein et al. (2009) was about 0.55, whereas the overlap from an affine registration ( Jenkinson et al., 2002 ) was 0.40. For IBSR40, the mean and median overlaps were 0.750 and 0.751 for GS1, and 0.751 and 0.753 respectively for GS2. Mean and median overlaps from the Dartel approach were 0.751 and 0.753, very similar to the results from GS2. The highest median overlap reported by Klein et al. (2009) was 0.73, and that from affine registration was 0.60.

For these data, the overlaps obtained from the GS approach are not much greater than those obtained from Dartel. The principal reason for this is that the nonlinear displacements were all relatively small (less than about 8.5 voxels anywhere in any of the brains) because the data had first been affine registered together. Evaluations with larger displacements are presented later in the paper.

Using the affine registration as a baseline, the results showed 15% to 20% greater accuracy improvements 4 when compared to those achieved for the most accurate of the nonlinear registration algorithms evaluated previously. These evaluations also showed that relatively small changes to the operator used to regularise the registration, can impact the final accuracies. Further exploration of the types of operators used, along with their various possible settings, could probably yield greater registration accuracy, but this was not the main aim of this work. Average overlaps (GS2) are shown for different brain structures 5 in Figs. 8 and 9 . Again, the plots show reasonably good overlap for the current method, compared to the best of the other algorithms.

There are some aspects of this evaluation, which some may claim do not provide a fair comparison against other methods. The first of these is that a group-wise registration scheme was used, and that this may have some “unfair” advantage over pairwise alignments. Certainly, there are advantages in terms of internal consistency among all the deformations, as well as execution times. However, as the main aim of inter-subject alignment is to align groups of subjects together, it would seem reasonable to try to achieve this using the most accurate strategy possible. Because the Dartel results were very similar to those from GS, the accuracy improvements demonstrated here seemed largely a result of the groupwise registration of tissue class images, rather than the way the deformations were parameterised.

The second potential criticism may be that the evaluations were done by the authors, rather than an “impartial” investigator. Occasionally, evaluations by other parties may be more about the competence of the investigator to run the approach, rather than of the algorithms themselves. As the alignments were based on matching tissue classes together, the output from the initial segmentations were visually examined beforehand, as these have a strong influence on the final results. In practice though, the algorithms were not adjusted in order to increase the accuracy for these particular datasets, and everything was run without any manual adjustments of the data (such as manual re-orienting). Figs. 10 and 11 show the templates resulting from the two datasets after registration.

One of the benefits of optimisation strategies that use second, as well as first, derivatives (such as Gauss–Newton or Levenberg–Marquardt) is that convergence is often much faster than approaches that use only the first derivatives (such as gradient descent). Here, convergence is assessed by plotting the value of the objective function with each iteration of the algorithm.

In the previous subsection, a coarse-to-fine strategy was used, with the aim of avoiding some of the potential local minima. In this section, there is no coarse-to-fine strategy and eight time steps are used for the integration of the deformations. The template (see Fig. 10 ) and regularisation were fixed to that used for the final iterations in the evaluations in the previous section. The convergence for each of the subjects in the LPBA40 dataset was assessed, and plots of the objective function for each iteration are shown in Fig. 12 .

The L 2 norm of the objective function gradients also provide a measure of convergence, so these are plotted in Fig. 13 . In theory, these gradients should approach zero at the solution. This situation is not quite achieved in practice using the pure Gauss–Newton procedure (with γ fixed at 1 in Eq. (29) ). The most likely reason for this is that the data are sampled discretely in the space of the template, leading to aliasing of high spatial frequency signal. This can cause the updates to overshoot slightly, causing the parameters to “bounce around” slightly for some regions of the images. Regularisation of the form described earlier (by reducing γ in Eq. (29) ) could have been used to ensure that these norms properly approach zero. This is not shown, as the aim was to demonstrate the behaviour with a pure Gauss–Newton algorithm.

Gradient descent algorithms often require hundreds of iterations to achieve convergence. This component of the evaluation was intended to show that reasonable convergence may be achieved with about 10 iterations of a Gauss–Newton algorithm. Slightly more exact solutions may be achieved by decreasing the update steps, although more iterations may be required.

Each iteration of the GS approach is slower than for many other registration algorithms. On a Dell Precision T3500, 6 each iteration took 43 s, whereas a Gauss–Newton iteration of Dartel (with six squaring steps) takes 20 s. The algorithm is of a type that should allow straightforward parallelisation, so further improvements could be achieved by implementing the most computationally intensive steps on GPUs.

In the previous evaluations, all subjects’ brains were relatively healthy and of similar ages, so the impacts of much larger displacements were not really investigated. Those evaluations also involved images that had been first aligned together via 12-parameter affine transforms. For morphometric applications, the aim is usually to consider both shape and size, in which case the registration may be initialised using a rigid-body alignment. To assess the effects of larger displacements, the IBSR40 images were all translated along the anterior-posterior direction by 12 mm (8 voxels), and re-registered with the template previously generated from un-translated versions of the data (GS2). The length of an adult human brain varies with a standard deviation of about 8 mm, so 12 mm may be a typical displacement required for nonlinear registration of rigidly aligned brains. Velocity fields resulting from the translated scans were compared with those estimated from un-translated data, quantifying similarities between parameterisations w a and w b using correlation coefficients computed by (37) r ab = w a T A w b w a T A w a w b T A w b where A is the large sparse matrix encoding the operator L † L . To reduce the penalty against absolute displacements, the values of λ 1 , λ 2 and λ 3 used were 0.5, 1.0 and 0.00001 respectively. These are the same as for GS2, but with a much lower value for λ 3 . Registrations of displaced data were done twice: once with initial velocity estimates set uniformly to zero (to provide poor starting estimates), and once with them set uniformly to 8 voxels (providing good starting estimates). Because no coarse to fine strategy was used, the first experiment assesses the robustness of the alignments with respect to initial misregistration, whereas the second assesses the properties of the deformation model. For all cases, 20 Gauss–Newton iterations of the registration algorithm were used.

The mean correlation coefficient between results from the GS approach done without translations, versus the results of GS2 (from the previous evaluations), was 0.98. Ignoring the fact that the regularisation was slightly different in terms of penalising absolute displacements, this result showed that the coarse-to-fine strategy only played a small role in the comparison with human expert segmentation.

The mean correlation coefficient between results from the Dartel and GS approaches, using un-translated data was 0.84. This is a reasonably high correlation, which suggests that when displacements are small, results obtained by registering using Dartel or GS are reasonaby similar to each other. However, a comparison between registration results from un-translated and translated data tells a different story. Using uniformly zero starting estimates, the correlation coefficients for GS were 0.52, whereas those for Dartel were only 0.19. This showed a highly significant difference between the behaviour of the two approaches. No coarse-to-fine strategy was used for these registrations, so much of the difference is likely to result from getting cought in local optima. By repeating the registration with starting estimates that encode a uniform displacement of 12mm, many of these local minima were avoided. With closer starting estimates (of the sort that the coarse-to-fine approach may help provide), the correlation coefficients were increased to 0.98 and 0.47 for GS and Dartel respectively. These clearly indicate the superiority of formulating registration using the LDDMM or GS framework, rather than that of Dartel. A comparison between Fig. 2 and the left-side panel of 5 illustrates where the discrepancies arise, and Fig. 6 also illustrates the differing behaviours of the two models. Fig. 14 shows divergences (trace of Jacobian tensors) of the various estimated velocity parameterisations for one subject (S40). The slice has an axial orientation and contains the anterior cingulate. The thing to observe from the figure is that the GS results are all more similar to each other than those from Dartel, and that the Dartel results from aligning translated scans (lower centre and lower right) shows a clear blurring along the directionof translation. The fact that Dartel may be less ideally suited for computational anatomy studies was mentioned in Ashburner (2007) .

## Conclusions
This work demonstrates that convergence of diffeomorphic registration can be speeded up with Gauss–Newton optimisation, and that the memory costs previously incurred by storing the entire sequence of velocity fields can be avoided. This overcomes some of the obstacles that currently hinder the widespread adoption of a more coherent computational anatomy framework. Although the alignment accuracy achieved from an implementation of this approach appears to be higher than that of other algorithms evaluated using the same datasets, further improvements in terms of the choice of differential operator etc should lead to even greater accuracy. The geodesic shooting algorithm is released as a toolbox for SPM8. 7