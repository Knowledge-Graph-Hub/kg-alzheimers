# Title
The Local Resolution of Cryo-EM Density Maps

# Abstract
Using local sinusoidal features in a standard statistical testing framework, we propose a definition of local resolution for 3D density maps. The resulting algorithm has no free parameters and may be extended to other imaging modalities. Evaluating the local resolution of single particle reconstructions and sub-tomogram averages shows variable resolution across a 4 to 40Å range.

## Methods
Methods and any associated references are available in the online version of the paper.

## Online Methods
This section presents mathematical details of the theory and algorithm. The mathematical formulation is in 3D, but actual computations are performed on column vectors, where the elements in 3D are inserted in order into the vector. To highlight this difference, 3D variables are displayed in ordinary type ( A ) and their vectorized counterparts in bold type ( A ).

We first describe how the density map can be approximated locally by any basis. Then, we introduce the 3D sinusoid-like feature basis used in our algorithm.

The 3D density map S is in a V × V × V voxel array. The voxels are indexed by discrete-valued coordinates x, y, z . We refer to a voxel in the array as v = ( v x , v y , v z ) where v x , v y , v z are its coordinates. The vectorized density map of S is a V 3 × 1 column vector S .

Suppose W v, α is a spherically symmetric Gaussian function centered at voxel v with scaling parameter α , (1) W v , α ( x , y , z ) = exp ( − α 2 [ ( x − v x ) 2 + ( y − v y ) 2 + ( z − v z ) 2 ] ) , and that φ k v, α , k = 1, … , K are basis functions centered at v . We then have (2) W v , α D S = W v , α D Φ v , α β + η , which locally approximates the density map S by basis functions φ k v, α . Here √ W D v, α is a diagonal matrix with √ W v, α along the principal diagonal, Φ v, α is a matrix whose columns are the basis functions φ k v, α , β is a column vector of the coefficients of the basis functions, and η is zero-mean Gaussian noise with variance σ 2 . Note that the weighting function W v, α determines the spatial extent of the local model.

To fit the local model to S we minimize the weighted residual sum of squares (WRSS v, α ) (3) WRSS v , α = ( S − Φ v , α β ) T W v , α D ( S − Φ v , α β ) = ‖ W v , α D ( S − Φ v , α β ) ‖ 2 , with respect to β . The minimizing coefficient vector is denoted as β ^ .

A natural basis for density maps is one containing rotated 3D sinusoids with wavelength λ Å. Unfortunately, describing all orientations in 3D requires an infinite number of basis functions. A computationally tractable alternative is to use steerable filters 9 ; 10 , which we refer to as “steerable functions”. Steerable functions are a finite set of functions with the property that every 3D rotation of any of the functions is produced by linear combinations of the functions 9 ( Supplementary Note 1 ).

The steerable functions we use are the second-order Hermite polynomial and its approximate quadrature, multiplied by a Gaussian function. We call this set H2. The elements of H2 match cosine and sine functions up to their second order Taylor expansion terms. They can also be scaled such that their spectral peak occurs at any desired wavelength. The H2 steerable functions are constructed from a pair of functions (4) G v , α ( x , y , z ) = P G v , α ( x , y , z ) W v , α ( x , y , z ) = [ 4 ( α ( x − v x ) ) 2 − 2 ] W v , α ( x , y , z ) , H v , α ( x , y , z ) = P H v , α ( x , y , z ) W v , α ( x , y , z ) = [ ( α ( x − v x ) ) 3 − 2.254 ( α ( x − v x ) ) ] W v , α ( x , y , z ) , where G v, α is the cosine-like function, H v, α is the sine-like function. The scalar α controls the peak frequency and the width of the Gaussian function. Setting α = 2π/ λ √2/√5 gives a spectral peak for G v, α and H v, α at wavelength λ ( Supplementary Note 2 ).

The functions in Equation (4) are each composed of the Hermite polynomial ( P G v,α ) or its quadrature ( P H v,α ) multiplied by W v, α , the spherically symmetric Gaussian weighting function. Their spectral peak occurs on the x -axis of the frequency domain because the functions are oriented along the the spatial x -axis. Rotating G v, α and H v, α so that their spectral peaks occur along the vertices and faces of an icosahedron respectively gives 6 + 10 3D steerable functions. The linear combination of these 16 functions produces all possible rotations of G v, α and H v, α in 3D 10 , thereby covering a shell in the 3D Fourier domain ( Supplementary Note 1 ).

We denote the rotated Hermite polynomials as P G v , α i , i = 1, ⋯, 6 and P H v , α i , j = 1, ⋯, 10. These polynomials and the constant function 1 are our local-sinusoid signal model. Because the weighting function W v, α appears outside of the basis matrix Φ v, α in Equation (2) , the Φ v, α matrix need only contain the vectorized polynomials, (5) Φ v , α = [ ∣ ∣ ∣ ∣ ∣ ∣ ∣ 1 P G v , α 1 ⋯ P G v , α 6 P H v , α 1 ⋯ P H v , α 10 ∣ ∣ ∣ ∣ ∣ ∣ ∣ ] , where the bold face denotes vectorization.

Testing whether the data in the neighborhood of voxel v support the local-sinusoid model is equivalent to testing the two hypotheses, (6) ℋ 0 : The constant term β 0 is unconstrained , but β 1 = ⋯ = β 16 = 0 , ℋ 1 : All of β 0 , β 1 , ⋯ , β 16 are unconstrained , where the null hypothesis ℋ 0 states that the data do not support the local-sinusoid model (the coefficients of all local-sinusoid terms are zero). The alternate hypothesis ℋ 1 allows the coefficients to take on any finite value.

The likelihood ratio test 11 is a standard procedure for comparing such hypotheses. The test works by calculating the β ’s that maximize the likelihood (probability) under each hypothesis and then taking the logarithm of the ratio of the maximized likelihoods. The β ’s that maximize the likelihood are found by minimizing the WRSS from Equation (3) under ℋ 0 and ℋ 1 , respectively. Many common statistical tests such as the Pearson χ 2 test and the F-test are derived from the likelihood ratio test ( Supplementary Note 3 ).

A simple calculation shows that the negative logarithm of the log-likelihood ratio, called the likelihood ratio statistic (LRS), is given by (7) LRS ( S ; v , α ) = 1 σ 2 ( ‖ W v , α D ( S − 1 β 0 ^ ) ‖ 2 − ‖ W v , α D ( S − Φ v , α β ^ ) ‖ 2 ) , = S T ( Γ 0 − Γ ) S σ 2 , where Γ 0 = W v , α D − W v , α D 1 ( 1 T W v , α D 1 ) − 1 1 T W v , α D , Γ = W v , α D − W v , α D Φ v , α ( Φ v , α T W v , α D Φ v , α ) − 1 Φ v , α T W v , α D .

The LRS is a difference of weighted residuals between the null model fit and the local-sinusoid model fit. It takes large values when the local-sinusoid model is a better fit than the null model.

The likelihood ratio test is applied by comparing the LRS to a number c , defined by (8) Pr [ S T ( Γ 0 − Γ ) S σ 2 < c ] = 1 − p , for some p-value p , usually 0.05. If LRS < c , then the data do not support the model and we accept the null hypothesis. Otherwise, we accept the hypothesis that the local-sinusoidal model fits the data.

Calculating the threshold c requires the statistical distribution of the LRS. Unfortunately, because of the weighting function W v, α , the LRS does not have a closed form statistical distribution. However, S T (Γ 0 − Γ) S asymptotically tends to a weighted sum of χ 2 random variables Σ r γ r χ 2 where γ r are the eigenvalues 18 of Γ 0 − Γ. Fast and accurate numerical methods are available to compute such distributions 19 .

The LRS computation requires the value of the noise variance σ 2 . We estimate this variance accurately by taking non-overlapping cubes of voxels from the region of the density map surrounding the particle. We use the following variance estimator recommended for local signal modeling 18 (9) σ ^ 2 = 1 B ∑ b = 1 B C b T ( Γ 0 − Γ ) C b trace ( Γ 0 − Γ ) , where C b is a cube of voxels from the background and B is the number of non-overlapping cubes that are available in the background. This estimator is robust to non-white noise as it only requires the noise spectrum to be relatively flat within the shell in 3D Fourier space that the local-sinusoid model, implicitly indicated by Γ, is approximating.

The noise variance may also be estimated from the difference map between split-dataset reconstructions. In this case, the estimator from Equation (9) is adjusted to accept cubes of voxels from the region inside the particle. The noise statistics inside and outside the particle are nearly identical ( Supplementary Note 4 ). Both noise variance estimators are implemented in the accompanying software package ( Supplementary Software ; http://resmap.sourceforge.net ).

The likelihood ratio test chooses between two hypotheses at each voxel. Since this test has to be repeated for many voxels in S , some sort of false discovery rate (FDR) control is necessary. The tests in neighboring windows are not independent from each other, therefore we use the Benjamini-Yekutieli FDR procedure 12 that accounts for dependencies between tests.

ResMap works by applying a hypothesis test at every voxel. The null hypothesis is that the data in the neighborhood of a voxel do not support a local sinusoid. The alternative hypothesis is that the data describe a local sinusoid. These features are modeled by 3D steerable functions. The likelihood ratio statistic is used to decide between the the hypotheses at a given p-value. Noise variance is estimated from the area surrounding the particle and multiple testing correction is applied to carry out the test at many voxels.