# Title
Single-cell multi-omic integration compares and contrasts features of brain cell identity

# Abstract
Defining cell types requires integrating diverse single-cell measurements from multiple experiments and biological contexts. To flexibly model single-cell datasets, we developed LIGER, an algorithm that delineates shared and dataset-specific features of cell identity. We applied it to four diverse and challenging analyses of human and mouse brain cells. First, we defined region-specific and sexually dimorphic gene expression in the mouse bed nucleus of the stria terminalis. Second, we analyzed expression in the human substantia nigra, comparing cell states in specific donors and relating cell types to those in the mouse. Third, we integrated in situ and single-cell expression data to spatially locate fine subtypes of cells present in the mouse frontal cortex. Finally, we jointly defined mouse cortical cell types using single-cell RNA-seq and DNA methylation profiles, revealing putative mechanisms of cell-type-specific epigenomic regulation. Integrative analyses using LIGER promise to accelerate investigations of cell-type definition, gene regulation, and disease states.

## Introduction
The function of the mammalian brain is dependent upon the coordinated activity of highly specialized cell types. Advances in high-throughput single-cell RNAseq (scRNAseq) analysis ( Klein et al., 2015 ; Macosko et al., 2015 ; Rosenberg et al., 2018 ; Zheng et al., 2017 ) have provided an unprecedented opportunity to systematically identify these cellular specializations, across multiple regions ( Saunders et al., 2018 ; Tasic et al., 2016 ; Zeisel et al., 2018 ), in the context of perturbations ( Hrvatin et al., 2018 ), and in related species ( Hodge et al., 2018 ; Lake et al., 2016 ; Tosches et al., 2018 ). Furthermore, new technologies can now measure DNA methylation ( Luo et al., 2017 ; Mulqueen et al., 2018 ), chromatin accessibility ( Cusanovich et al., 2018 ), and in situ expression ( Coskun and Cai, 2016 ; Moffitt and Zhuang, 2016 ; Wang et al., 2018 ), in thousands to millions of cells. Each of these experimental contexts and measurement modalities provides a different glimpse into cellular identity.

Integrative computational tools that can flexibly combine individual single-cell datasets into a unified, shared analysis offer many exciting biological opportunities. The major challenge of integrative analysis lies in reconciling the immense heterogeneity observed across individual datasets. Within one modality of measurement—like scRNA-seq—datasets may differ by many orders of magnitude in the number of cells sampled, or in the depth of sequencing allocated to each cell. Across modalities, datasets may vary widely in dynamic range (gene expression versus chromatin accessibility), direction of relationship (RNA-seq versus DNA methylation), or in the number of genes measured (targeted quantification versus unbiased approaches). To date, the most widely used data alignment approaches ( Butler et al., 2018 ; Haghverdi et al., 2018 ; Johnson et al., 2007 ; Risso et al., 2014 ) implicitly assume that the differences between datasets arise entirely from technical variation and attempt to eliminate them, or map datasets into a completely shared latent space using dimensions of maximum correlation ( Butler et al., 2018 ). However, in many kinds of analysis, both dataset similarities and differences are biologically important, such as when we seek to compare and contrast scRNA-seq data from healthy and disease-affected individuals.

To address these challenges, we developed a new computational method called LIGER ( L inked I nference of G enomic E xperimental R elationships). We show here that LIGER enables the identification of shared cell types across individuals, species, and multiple modalities (gene expression, epigenetic or spatial data), as well as dataset-specific features, offering a unified analysis of heterogeneous single-cell datasets.

## Results
LIGER takes as input multiple single-cell datasets, which may be scRNA-seq experiments from different individuals, time points, or species—or measurements from different molecular modalities, such as single-cell epigenome data or spatial gene expression data ( Figure 1A ). LIGER then employs integrative non-negative matrix factorization (iNMF) ( Yang and Michailidis, 2016 ) to learn a low-dimensional space in which each cell is defined by one set of dataset-specific factors, or metagenes, and another set of shared metagenes ( Figure 1B ). Each factor often corresponds to a biologically interpretable signal—like the genes that define a particular cell type. A tuning parameter, λ , allows adjusting the size of dataset-specific effects to reflect the divergence of the datasets being analyzed. We found that iNMF performs comparably to both NMF and principal component analysis (PCA) in reconstructing the original data ( Figures S1A - B ). After performing iNMF, we use a novel strategy that increases robustness of joint clustering. We first assign each cell a label based on the maximum factor loading, then build a shared factor neighborhood graph ( Figure 1C ), in which we connect cells that have similar factor loading patterns ( Methods ).

We derived a novel algorithm for iNMF optimization, which scales well with the size of large single-cell datasets ( Figures S1C - D and Methods ). To aid selection of the key parameters—the number of factors k and the tuning parameter λ —we developed heuristics based on factor entropy and dataset alignment ( Methods ). Overall, these heuristics performed well across different analyses ( Figure S1I - J ), though we have observed that manual tuning can sometimes improve the results. Additionally, we derived novel algorithms for rapidly updating the factorization to incorporate new data or change parameters ( Methods and Figure S1E - H ). We anticipate that this capability will be useful for leveraging a rapidly growing corpus of single-cell data.

We assessed the performance of LIGER through the use of two metrics: alignment and agreement . Alignment ( Butler et al., 2018 ) measures the uniformity of mixing for two or more samples in the aligned latent space. This metric should be high when datasets share underlying cell-types, and low when datasets do not share cognate populations. The second metric, agreement, quantifies the similarity of each cell’s neighborhood when a dataset is analyzed separately versus jointly with other datasets. High agreement indicates that cell type relationships are preserved with minimal distortion in the joint analysis.

We calculated alignment and agreement metrics using published datasets ( Baron et al., 2016 ; Gierahn et al., 2017 ; Saunders et al., 2018 ), comparing the LIGER analyses to those generated by the Seurat package ( Butler et al., 2018 ). We first ran our analyses on a pair of scRNA-seq datasets from human blood cells that show primarily technical differences ( Gierahn et al., 2017 ) and should thus yield a high degree of alignment. Indeed, LIGER and Seurat show similarly high alignment statistics ( Figures 2A - C ), and LIGER’s joint clusters match the published cluster assignments for the individual datasets. LIGER and Seurat also performed similarly when integrating human and mouse pancreatic data, with LIGER showing slightly higher alignment ( Figure 2C ).

In both analyses, LIGER produced considerably higher agreement than Seurat ( Figure 2D ), suggesting better preservation of the underlying cell-type architectures in the integrated space. We expected this advantage should be especially beneficial when analyzing very divergent datasets that share few or no common cell populations. To confirm this, we jointly analyzed profiles of hippocampal oligodendrocytes and interneurons ( Saunders et al., 2018 ), two cell classes with very different developmental origins. LIGER generated minimal false alignment between these classes and demonstrated a good preservation of complex internal substructure ( Figures 2D - F , S2A - C ), even across considerable changes in dataset proportion ( Figures 2G - H ). In each of the three analyses described above, the LIGER joint clustering result closely matched the published cluster assignments for the individual datasets ( Figures 2I , S2D - E ). Together, these analyses indicate that LIGER sensitively detects common populations without spurious alignment and preserves complex substructure, even when applied across divergent datasets.

An important application of integrative analysis in neuroscience is to quantify cell-type variation across different brain regions and different members of the same species. To examine LIGER’s performance in these tasks, we analyzed the bed nucleus of the stria terminalis (BNST), a subcortical region comprised of multiple subnuclei ( Dong and Swanson, 2004 ) implicated in social, stress-related, and reward behaviors ( Bayless and Shah, 2016 ). To date, scRNA-seq has not been performed on BNST, providing an opportunity to clarify how cell types are shared between this structure and datasets generated from related tissues.

We isolated, sequenced, and analyzed 204,737 nuclei enriched for the BNST region ( Figure S3A , Methods ). Initial clustering identified 106,728 neurons, of which 70.2% were localized to BNST by examination of marker expression in the Allen Brain Atlas (ABA) ( Lein et al., 2007 ) ( Figure S3B ). Clustering analysis revealed 41 transcriptionally distinct populations of BNST-localized neurons ( Figure 3A ). In agreement with previous estimates ( Kudo et al., 2012 ), 85.9 % of the cells were inhibitory (expressing Gad1 and Gad2 ), while the remaining 14% were excitatory (expressing Slc17a6 (9.4%) or Slc17a8 (4.7%) ( Figure S3C ). Examination of cluster markers in the ABA showed that many cell types localized to specific BNST substructures, including the principal, oval, and anterior commissure nuclei ( Figure S3C and S3D ). For example, we identified two molecularly distinct subpopulations in the oval nucleus of the anterior BNST (ovBNST) ( Figure 3B ), a structure known to regulate anxiety ( Kim et al., 2013 ) and to manifest a robust circadian rhythm of expression of Per2 ( Amir et al., 2004 ), similar to the superchiasmatic nucleus (SCN) of the hypothalamus.

Two clusters, BNST_Vip and BNSTp_Cplx3, expressed markers of caudal ganglionic eminence (CGE)-derived interneurons found in cortex and hippocampus. Part of the BNST has embryonic origins in the CGE ( Nery et al., 2002 ), suggesting that this structure may harbor such cell types. To examine this possibility, we integrated the 352 nuclei from the BNST_Vip and BNST_Cplx3 clusters with 1,060 CGE interneuron cell profiles sampled from our recent adult mouse frontal cortex dataset ( Saunders et al., 2018 ). Four clusters in the LIGER analysis showed meaningful alignment between BNST nuclei and cortical CGE cells ( Figure 3C ). Cluster 1 expressed Vip, Htr3a, Cck , and Cnr1 , likely corresponding to VIP+ basket cells ( Rudy et al., 2011 ) ( Figures 3D - E ). A second population, which was Vip-negative and likely localized to the posterior BNST ( Figure 3E ), expressed Id2, Lamp5, Cplx3, and Npy , all markers known to be present in cortical neurogliaform (NG) cells ( Tasic et al., 2016 ) ( Figure 3D ). Although, to our knowledge, NG cells have not been described in the BNST before, cells with NG-like anatomy and physiology have been observed within the amygdala ( Manko et al., 2012 ), a structure with related functional roles.

Spiny projection neurons (SPNs) are the principal cell type of the striatum, a structure just lateral to the BNST, but cells expressing the canonical SPN marker, Ppplrlb , have also been documented in multiple anterior BNST nuclei ( Gustafson and Greengard, 1990 ). The molecular relationship between striatal SPNs and these BNST cells is not known. We identified three Ppp1r1b+ populations—one specifically BNST-localized and two without BNST-specific localization (8,624 nuclei, Figures S3B and S3D ). To relate these putative SPNs to striatal SPNs, we used LIGER to integrate these three clusters with 10,934 published striatal SPN profiles ( Saunders et al., 2018 ). Many of the nuclei from our dataset aligned to clusters 1 and 2 ( Figure 3F ) corresponding to canonical striatal SPNs of the iSPN and dSPN types, respectively. A second population of our nuclei aligned to cluster 3, containing the striatal eSPNs we recently described ( Saunders et al., 2018 ). A fourth population, cluster 4, expressed markers localizing it exclusively to the rhomboid nucleus of BNST ( Figures 3G and 3H ). These results suggest that the BNST contains a combination of SPN-like neurons with high homology to striatal SPNs, while also harboring at least one Ppp1r1b+ population with tissue-specific specializations.

In addition to its high molecular and anatomical diversity, BNST also displays significant sexual dimorphism, both in size ( Allen and Gorski, 1990 ; Hines et al., 1992 ) and gene expression ( Xu et al., 2012 ). To identify cell-type-specific BNST dimorphism, we used LIGER to identify sex-specific metagene factors. X- and Y-chromosome genes such as Xist, Tsix, Eif2s3y, Ddx3y , and Uty showed high loading values on dataset-specific factors, reinforcing that these factors captured dimorphic gene expression. We then used the dataset-specific factor loadings to quantify the number of cell-type-specific dimorphic genes for each cluster ( STAR Methods ).

Our analysis revealed a complex pattern of dimorphic expression involving differences across many individual cell types. Clusters BNSTpr_St18 and BNSTpr_Esr2 from the BNST principal nucleus (BNSTpr) showed some of the highest numbers of dimorphic genes ( Figure 3I ), consistent with previous reports that BNSTpr is particularly dimorphic ( Hines et al., 1992 ; Xu et al., 2012 ). To illustrate the interpretability of the factorization and the complexity of the dimorphism patterns it reveals, we plotted the loading pattern and cell-type-specific dimorphic genes derived from one particular factor (factor 27) that loads strongly on the BNSTpr_St18 cluster ( Figure 3J ). Among the top dimorphic genes for this factor were Xist, Tsix , and Etl4. We devised a metric from the LIGER analysis to rank genes by their cell-type-specific dimorphism ( Figure 3K and Methods ), flagging genes expressed at higher levels in male or female within a specific population. Among 12 genes previously confirmed to be dimorphic in BNST ( Xu et al., 2012 ), we found that most had high cell-type-specific expression metrics. We also identified new dimorphic genes, often with complex cell-type-specific dimorphisms across the many BNST subpopulations ( Figure 3L and Supplementary File 1 ).

Profiling of individual nuclei from archival postmortem human brain samples ( Habib et al., 2017 ; Lake et al., 2016 ) provides an exciting opportunity to comprehensively characterize transcriptional heterogeneity across the human brain. However, many ante- and postmortem variables create complex technical variation in gene expression, complicating efforts to identify biological variation in cell state. To explore how well LIGER can integrate individual human postmortem samples, we isolated and sequenced 44,274 nuclei derived from the substantia nigra (SN) of seven individuals designated as neurotypical controls ( Methods ). The SN is a subcortical structure that functions in reward and movement execution and degenerates in Parkinson’s disease. Despite considerable inter-individual variation ( Figure S4A ), LIGER accurately integrated each of the cell-type substituents of the SN across datasets ( Figure 4A ). Specifically, we identified 24 clusters spanning all known resident cell classes: astrocytes, fibroblasts, mural cells, microglia, neurons (including TH+ dopaminergic neurons and multiple inhibitory types), oligodendrocytes, and oligodendrocyte progenitor cells (polydendrocytes) ( Figure 4B - C ).

Glial activation is an important hallmark and driver of many brain diseases, including neurodegeneration and traumatic brain injury (TBI). To uncover datasets with atypical glial expression patterns, we examined the dataset-specific metagenes of glial cell types. The dataset-specific component of factor 28 showed that subject MD5828 had high expression of immediate early genes within polydendrocytes ( Figure 4D ), consistent with an acute injury ( Dimou et al., 2008 ). Although this subject was coded as a control, the cause of death strongly suggested brain trauma ( Methods ). In addition, the MD5828- specific metagene for factor 5, which was microglia-specific, had high loadings of TMSB4X and CSF1R , both of which play important roles in the acute response to TBI ( Luo et al., 2013 ; Xiong et al., 2012 ). By contrast, in subject 5840, the dataset-specific loadings on the microglial factor 5 included genes upregulated in response to amyloid deposition ( Figure 4E ). Review of this subject’s postmortem report revealed a histological diagnosis of cerebral amyloid angiopathy (CAA), in which amyloid deposits within the walls of CNS vasculature. Intriguingly, two of the three genes known to cause hereditary CAA ( Biffi and Greenberg, 2011 ), CST3 and ITM2B, were also strong contributors to MD5840-specific factor 5. In an astrocyte-specific factor (factor 20), subject MD5840 showed remarkable upregulation of multiple genes involved in protein misfolding response ( Figure 4F ) ( Tsaytler et al., 2011 ), several of which are known to be amyloid-responsive ( Bruinsma et al., 2011 ).

A deeper understanding of cell types often arises from comparisons across species. We therefore used LIGER to compare our newly generated human SN data with a recently published dataset from the mouse SN ( Saunders et al., 2018 ). The joint analysis identified both corresponding broad cell classes across species, and subtler cell types within each class after a second round of analysis ( Figures S4B - S4F ). In our subanalysis of the neurons, LIGER avoided false positive alignments of human profiles to mouse cell types outside the dissection zone of the human tissue ( Figures S4G and S4H ). Overall, we observed strong concordance between mouse and human cell clusters, consistent with a recent analysis of mouse and human cortex ( Hodge et al., 2018 ).

Understanding how expression of homologous genes within the SN differs across species could reveal differences in how these genes function within the tissue. We performed gene ontology (GO) term enrichment analysis to evaluate whether genes with the highest and lowest correlation across species share any functional relationships. Homologous gene pairs with high expression correlation were enriched for GO terms related to brain cell identity and basic molecular functions, including ion channels, transcription factors, transmembrane receptors, and extracellular matrix structural components ( Figure 4G ). In contrast, the least correlated homologous gene pairs were enriched for basic metabolic processes, such as macromolecule metabolism and DNA repair ( Figure 4H ). Intriguingly, genes involved in chromatin remodeling (sharing the GO function “chromatin organization”) also showed less expression conservation, hinting at species differences in epigenetic regulation.

Spatial context is an important aspect of cellular identity, but most studies have used scRNA-seq from dissociated cells to define cell types. Integrating these data types using LIGER could offer two potential advantages compared to separate analyses: (1) assigning spatial locations to cell clusters observed in data from dissociated cells; and (2) increasing the resolution for detecting cell clusters from the in situ data.

We jointly analyzed frontal cortex scRNA-seq profiles prepared by Drop-seq ( Saunders et al., 2018 ) and in situ spatial transcriptomic data from the same tissue generated by STARmap ( Wang et al., 2018 ). These two datasets differ widely in number of cells (71,000 scRNA-seq vs. 2500 STARmap) and genes measured per cell (scRNA-seq is unbiased, while STARmap is targeted). Nevertheless, LIGER correctly defined joint cell populations across the datasets ( Figure 5A - B ), with expression of key marker genes confirming the correspondence of cells across these different modalities ( Figure 5C ). Only one population in the scRNA-seq data was dataset-specific, corresponding to cells from the claustrum, an anatomical structure not included in the STARmap field-of-view ( Figure S5A ). Our integrated analysis spatially located each of the jointly defined populations ( Figure 5D ) and reflected the known spatial features of the mouse cortex, including meninges and sparse layer 1 interneurons at the surface, excitatory neurons organized in layers 2-6, and oligodendrocyte-rich white matter below the cortex ( Figure 5D ). One replicate of the STARmap data also showed a chain of endothelial cells running through the cortex, likely a contiguous segment of vasculature ( Figure 5D ). The success of this integrative analysis is especially noteworthy given the very different global distributions of gene expression values in the scRNA-seq data (sparse) compared to the STARmap data (non-sparse) ( Figure 5E ).

Incorporating the scRNA-seq data also identified cell populations from STARmap with greater resolution than the published clustering. Specifically, we identified 7 interneuron clusters and 5 glial clusters compared to 4 and 2 clusters, respectively, in the initial STARmap analysis. These additional populations accorded well with cell-type distinctions defined in the original scRNA-seq analysis. The 5 glial clusters we identified included two astrocyte clusters, polydendrocytes, and two clusters of oligodendrocytes ( Wang et al., 2018 ). The two astrocytic subpopulations expressed patterns of marker genes consistently between both the scRNA-seq and STARmap datasets ( Figure 5F ). The larger population expressed high levels of Mfge8 and Htral, while the second population showed high expression of Gfap ( Figure 5F ). The Gfap -expressing astrocyte population is located outside the cortical gray matter, in both the meningeal lining and the white matter below layer 6 ( Figure 5G , 5H ), consistent with a more fibrous identity. In contrast, the larger second population of astrocytes was spread uniformly throughout the cortical layers, consistent with a protoplasmic phenotype. Identifying the localization of the Gfap -expressing astrocyte population also clarified our human-mouse substantia nigra analysis ( Figure S4E ), suggesting that this same Gfap -expressing population is likely missing from the human data because of dissection differences. These results show the power of jointly leveraging large-scale scRNA-seq and in situ gene expression data for defining cell types in the brain.

We also investigated whether it is possible to predict the spatial patterns of genes not assayed by STARmap. To do this, we assigned each STARmap cell to the average of its nearest Drop-seq neighbors in the aligned factor space ( STAR Methods ). Comparison of predicted gene patterns with the ABA showed that LIGER is able to reveal even complex spatial expression patterns across many individual genes ( Figure S5B - D ). Most high-error genes either showed technical differences in measurement between STARmap and Drop-Seq (e.g., Aldoc, Tsnax, Hlf ) or possessed no obvious spatial pattern (e.g., Elmol, Glul, Scg2 ) ( Figure S5E - G ).

Linking single-cell epigenomic data with scRNA-seq would open exciting avenues for investigation. First, it is unknown whether clusters defined from gene expression reflect epigenetic distinctions and vice versa. Second, integrating single-cell epigenomic and transcriptomic data provides an opportunity to study the mechanisms by which epigenomic information regulates gene expression to determine cell identity. Finally, such integration may improve sensitivity and interpretability compared to analyzing the epigenomic data in isolation, since scRNA-seq technology can offer greater throughput and capture more information per cell.

To investigate these possibilities, we performed an integrated analysis of two single-cell datasets prepared from mouse frontal cortical neurons: one of gene expression (55,803 cells) ( Saunders et al., 2018 ) and another of genome-wide DNA methylation (3,378 cells) ( Luo et al., 2017 ). We reasoned that, because non-CpG (mCH) gene body methylation is generally anticorrelated with gene expression in neurons ( Mo et al., 2015 ), reversing the direction of the methylation signal would allow joint analysis. Indeed, LIGER successfully integrated the datasets, jointly identifying the neuronal cell types of the frontal cortex and according well with the published analyses of each dataset ( Figure 6A - C ).

Our joint analysis clarified the identities of some methylation clusters. We found that a cluster annotated as “deep layer cluster 3” aligned uniquely to an RNA-seq cluster that we previously had annotated as claustrum ( Saunders et al., 2018 ) ( Figures 6C , D ). In addition, a cluster annotated as “layer 6 cluster 1” aligned with a cluster that we identified as layer 5b. The canonical marker genes have relatively low overall methylation levels, making it challenging to assign the identity of this cell type from methylation alone. However, the expression of several specific layer 5b marker genes, most notably Slc17a8 ( Sorensen et al., 2015 ), and their corresponding low methylation pattern in the aligned cluster mL6–1 cells, enabled us to confirm this assignment ( Figure S6A ).

We performed four sub-analyses of the broad cell classes in the frontal cortex: CGE-derived interneurons, MGE-derived interneurons, superficial excitatory neurons, and deep-layer excitatory neurons ( Figures S5C - S5E ), identifying a total of 37 clusters. Joint analysis of MGE interneurons revealed 11 populations, considerably more than was possible using the methylation data alone ( Figure 6E ). Examining expression and methylation of marker genes confirmed that these populations are real and not simply forced alignment ( Figure 6F ). We were even able to credibly identify 25 methylation profiles corresponding to an interneuron population expressing Pvalb and Th ( Figure S6B ), as well as 5 profiles aligning to the cluster expressing Sst and Chodl ( Figure 6G ). Together, these results indicate that epigenomic and expression data produce meaningful joint neural cell-type definitions, and even the finest distinctions among neural cell types defined from gene expression can be reflected by DNA methylation differences.

Our joint cluster definitions offered an opportunity to investigate the regulatory relationship between expression and methylation at cell-type-specific resolution. We first aggregated the gene expression and methylation values within each cluster, then calculated correlation between the expression of each gene and its gene body methylation levels across the set of clusters. Consistent with previous work, we found an overall negative relationship between methylation and expression ( Figure 7A ). We also leveraged this inverse relationship to predict spatial methylation patterns ( Figure S7A ; Methods ). Consistent with previous work ( Luo et al., 2017 ; Mo et al., 2015 ), we found that non-CpG methylation within the gene body, rather than CpG methylation (mCG), was more anticorrelated with expression ( Figure S7B ), and anticorrelation was weaker in mCH deserts ( Figure S7C ), megabase-scale regions with very low mCH relative to mCG ( Lister et al., 2013 ). We also found that using mCG resulted in poorer cluster separation compared with mCH ( Figures S7D - E ). Longer genes showed stronger negative correlation with gene expression than shorter genes ( Figure 7A ), consistent with a known mechanism of gene repression by DNA methylation, in which the MECP2 protein binds methylated nucleotides ( Fasolino and Zhou, 2017 ). The degree of MECP2 repression has been shown to be proportional to the number of methylated nucleotides, which is strongly related to gene length ( Kinde et al., 2016 ). Since gene length also affects the amount of measured methylation signal in these sparse profiles, we cannot completely rule out the influence of technical factors in this observed relationship.

We observed a wide range of global methylation levels across our set of clusters( Figure 7B ), providing an opportunity to investigate the basic molecular machinery involved in regulating methylation. We correlated the expression of several key genes with the global methylation level of each cell. We found that expression of Mecp2 correlated strongly ( ρ = 0.46, p = 0.0039) with global methylation level ( Figure 7C ), supporting a model in which MECP2 represses gene expression by specifically binding to methylated nucleotides ( Kinde et al., 2016 ), creating a stoichiometric requirement for increased Mecp2 expression in cells with higher overall methylation levels. In addition, we found that Tet3 , which converts 5mC to 5hmC, strongly anticorrelated ( ρ = −0.57, p = 0.0002) with global methylation ( Figure 7D ). Intriguingly, the other TET genes were not anticorrelated with global methylation despite similar overall expression levels ( Figure S7E and S7F ), suggesting that Tet3 could be the dominant TET protein regulating global methylation in mature neurons. Gadd45b , a gene with a well-established role in demethylating neuronal DNA ( Bayraktar and Kreutz, 2018 ), also showed a strong negative relationship ( ρ = −0.30, p = 0.0685) with global methylation. Consistent with our analysis, Gadd45b is thought to regulate DNA demethylation by recruiting TETs ( Bayraktar and Kreutz, 2018 ). By contrast, none of the DNA methyltransferase enzymes (DNMTs) were strongly related to overall methylation level ( Figures S7G - S7I ). These analyses show the value of an integrated analysis to formulate hypotheses about the mechanisms by which expression and methylation are regulated.

Our integrated analysis could also enable the identification of intergenic elements regulating cell-type-specific gene expression. We defined a set of stringent criteria that combined intergenic methylation status, transcription factor expression, and transcription factor sequence specificity, to identify such intergenic regions--and the transcription factors that may bind them--in specific cell types ( STAR Methods ) ( Figure 7F ). These represent strong candidates for cell-type-specific transcriptional regulatory elements, as they harbor unmethylated transcription factor binding motifs in cell types with high expression of the corresponding transcription factors.

Finally, our integrated definition of cell types from methylation and expression allowed us to examine the relationship between intergenic methylation and the expression of nearby genes. The Arx locus harbors 8 ultraconserved elements (UCEs)—long stretches of sequence showing perfect conservation among human, mouse, and rat ( Bejerano et al., 2004 ; Colasante et al., 2008 ). Several distal regulatory elements, including some located within neighboring UCEs, have recently been demonstrated to regulate Arx expression ( Colasante et al., 2008 ; Dickel et al., 2018 ). To nominate putative elements regulating Arx , we correlated Arx expression and methylation of nearby differentially methylated regions (DMRs) across our joint clusters ( Figure 7G ). We observed several clusters of DMRs whose methylation is anticorrelated with Arx expression, a pattern expected if hypo-methylation within certain cell types makes available a regulatory element that enhances Arx expression. One of these anticorrelated DMRs is a validated Arx enhancer ( Dickel et al., 2018 ) just downstream of the end of the Arx gene ( Figure 7G , middle). Another pair of DMRs strongly correlated with Arx expression overlap a UCE further downstream of Arx ( Figure 7G , right). A third group of DMRs upstream of the Arx site lies in a region of very high conservation (though not a UCE), with three clear spikes in conservation that aligned precisely with the locations of the DMRs ( Figure 7 H, left). In summary, these DMRs represent strong candidates for putative elements regulating Arx expression, highlighting the value of our integrative approach for investigating gene regulatory mechanisms.

## Discussion
A credible definition of cell type requires distinguishing the invariant properties of cell identity from the dispensable across a myriad of settings and measurements. LIGER promises to be a broadly useful analytical tool for such efforts because of several key technical advantages. First, the nonnegativity constraint of NMF yields interpretable factors, such that each factor generally corresponds to a biologically meaningful signal. Second, the inclusion of dataset-specific terms allows us to identify dataset differences, rather than attempting to force highly divergent datasets into a completely shared latent space. Finally, LIGER’s inference of both shared and dataset-specific factors enables a more transparent and nuanced definition of how cells correspond across datasets. In cases where complete correspondence is not necessarily expected—such as connecting fully differentiated cells to progenitors or relating pathological cells to healthy counterparts—a characterization of the metagenes that both unite and separate such populations is crucial. We note that one limitation of existing methods for multi-omic integration, including LIGER, is their inability to incorporate different types of features, such as gene expression and intergenic methylation, in the definition of cell types. Future studies may investigate how best to incorporate such information.

Another integration algorithm, described in this issue by Stuart et al., uses canonical correlation analysis (CCA) to identify a completely shared subspace of maximum correlation, then uses these shared components to identify anchor points across heterogeneous datasets. CCA solves a convex optimization problem and thus guarantees a deterministic, globally optimal solution. In contrast, LIGER uses integrative nonnegative matrix factorization, which solves a non-convex optimization problem, and thus produces a different factorization depending on the initialization used. LIGER infers interpretable shared and dataset-specific factors, which often correspond to important biological signals, including signals that are not orthogonal to cell type, or technical signals, enabling their removal from downstream analysis.

We envision LIGER serving several important needs in neurobiology, beyond its capacity to better define cell types. First, a key opportunity in single-cell analysis is the identification of cell-type-specific gene expression patterns associated with disease risk, onset and progression in human tissue samples. Early efforts at such investigation have yielded some exciting results ( Keren-Shaul et al., 2017 ), but increased discovery is likely possible with robust integrative analysis of many tissue donors. Such analyses may also help localize genetic risk loci for neuropsychiatric diseases to specific human cell types. Second, the integration of data from epigenomic and transcriptomic datasets provides a path towards nominating functional genomic elements important in cell-type-specific gene regulation. Such elements are compelling candidates for cell-type-specific enhancers to drive expression of genetic tools in specific subsets of brain cells, and may also help narrow the search for causative alleles at specific genetic risk loci. Finally, as in vitro models of complex brain tissues become more sophisticated ( Birey et al., 2017 ; Quadrato et al., 2017 ), single-cell gene expression measurements, together with an integrative analysis like LIGER, will help provide systematic, information-rich comparisons of such models with their in vivo counterparts. To facilitate adoption of the tool in the community, we have developed an R package that supports analysis of large-scale datasets and includes ancillary functions for tuning algorithmic parameters, visualizing results, and quantifying integrative performance. We hope its widespread deployment opens many exciting new avenues in single-cell biology.

## CONTACT FOR REAGENT AND RESOURCE SHARING
Further information and requests for resources and reagents should be directed to and will be fulfilled by the Lead Contact, Evan Macosko( emacosko@broadinstitute.org ).

## EXPERIMENTAL MODEL AND SUBJECT DETAIL
Nuclei suspensions for the BNST experiments were generated from 8 adult male and 7 adult female mice (60-70 days old; C57BL/6J, Jackson Labs). All experiments were approved by and in accordance with Broad Institute IACUC protocol number 0120-09-16.

Nuclei suspensions for the human substantia nigra experiments were generated from seven tissue donors (five males, three females, age range 18-75), supplied by the University of Maryland Brain Bank, through the NIH NeuroBioBank. Although all seven donors were coded as neurotypical controls, information provided with the tissue revealed that donor 5828 suffered a traumatic brain injury at the time of death, while donor 5840 was diagnosed at autopsy with cerebral amyloid angiopathy. This work was determined by the Office of Research Subjects Protection at the Broad Institute not to meet the definition of human subjects research (project ID NHSR-4235).

## METHOD DETAILS
A typical workflow for Integrating multiple single-cell datasets using the LIGER software package consists of the following steps: Dataset preprocessing to produce a raw digital gene expression (DGE) matrix. Variable gene selection ( Saunders et al., 2018 ), normalization by number of UMIs, and scaling of individual genes. We scale but do not center gene expression because NMF requires nonnegative values. Identifying shared and dataset-specific factors through integrative non-negative matrix factorization (iNMF). We have derived and implemented a novel coordinate descent algorithm for efficiently performing the factorization. Jointly clustering cells and normalizing factor loadings. Visualization using t-SNE or UMAP and analysis of shared and dataset-specific marker genes.

Dataset preprocessing to produce a raw digital gene expression (DGE) matrix.

Variable gene selection ( Saunders et al., 2018 ), normalization by number of UMIs, and scaling of individual genes. We scale but do not center gene expression because NMF requires nonnegative values.

Identifying shared and dataset-specific factors through integrative non-negative matrix factorization (iNMF). We have derived and implemented a novel coordinate descent algorithm for efficiently performing the factorization.

Jointly clustering cells and normalizing factor loadings.

Visualization using t-SNE or UMAP and analysis of shared and dataset-specific marker genes.

The important components of each step are described more formally and in detail below, while vignettes which describe specific commands for analyses included in Figure 2 are available online at https://macoskolab.github.io/liger/ .

We developed a novel block coordinate descent algorithm for performing integrative non-negative matrix factorization ( Yang and Michailidis, 2016 ). This approach learns a set of latent metagene factors, each with both shared and dataset-specific components, to approximate the original datasets. To estimate these matrix factors, we minimize the following objective: (1) arg min H ≥ 0 , W ≥ 0 , V ≥ 0 ∑ d i ‖ E i − H i ( W + V i ) ‖ F 2 + λ ∑ d i ‖ H i V i ‖ F 2 # ( 1 )

This approach attempts to reconstruct each of the original datasets E i (of dimension n i × m ) using lower dimensional matrices H i , W , and V i , such that Ei ≈ H i ( W + V i ), where all factor matrices are constrained to be non-negative. Note that W is shared across all datasets i = 1… d , while the H i and V i matrices are unique to each dataset. The inner dimension k of these factors can be interpreted as the number of “metagenes” (or conversely “metacells”) used to represent the datasets.

We divide the variables into 2 d + 1 blocks (corresponding to H and V for each dataset, as well as W ) and perform block coordinate descent, iteratively minimizing the objective with respect to each block, holding the others fixed. We iterate: W = arg min W ≥ 0 ‖ ( H 1 ⋮ H d ) W − ( E 1 − H 1 V 1 ⋮ E d − H d V d ) ‖ F 2 H i = arg min H i ≥ 0 ‖ ( W T + V i T λ V i T ) H i T − ( E i T 0 g × n i ) ‖ F 2 V i = arg min V i ≥ 0 ‖ ( H i λ H i ) V i − ( E i − H i W 0 n i × g ) ‖ F 2 ( 0 c × d is the zero matrix of dimension c × d ). until convergence. Each of the optimization subproblems above requires solving a nonnegative least squares problem; we use the fast block principal pivoting algorithm developed by Kim et al. ( Kim, 2014 ) to solve each of these subproblems exactly. As described in Kim et al, our block coordinate descent algorithm satisfies the requirements of the theorem of Bertsekas ( Bertsekas, 1999 ), because each of the subproblems is convex with respect to the block of variables being optimized. Thus, the algorithm is guaranteed to converge to a fixed point (local minimum). In contrast, the multiplicative updates often used for NMF-like optimization problems do not have a convergence guarantee. Additionally, because we solve each subproblem exactly at each iteration, the algorithm converges very quickly; previous empirical benchmarks ( Kim, 2014 ) and our own have shown that block coordinate descent algorithms for NMF generally converge in many fewer iterations than multiplicative updates ( Figure S1A - B ). We developed an efficient implementation of the algorithm using the Rcpp package in R.

W = arg min W ≥ 0 ‖ ( H 1 ⋮ H d ) W − ( E 1 − H 1 V 1 ⋮ E d − H d V d ) ‖ F 2

H i = arg min H i ≥ 0 ‖ ( W T + V i T λ V i T ) H i T − ( E i T 0 g × n i ) ‖ F 2

V i = arg min V i ≥ 0 ‖ ( H i λ H i ) V i − ( E i − H i W 0 n i × g ) ‖ F 2 ( 0 c × d is the zero matrix of dimension c × d ).

We adapted a method, previously developed for regular NMF ( Kim, 2014 ), for rapidly updating a factorization given new data or new values of k or λ . Suppose we have optimized (1) with k 1 factors to give matrices H i ( n i × k 1 ) , V i ( k 1 × g ) and W ( k 1 × g ) To efficiently compute a factorization with k 2 factors, we consider two cases: k 2 > k 1 and k 2 < k 1 . If k 2 > k 1 , we initialize the k 2 – k 1 new factors to factorize the residual from the previous solution, then solve using alternating nonnegative least squares as before. For k 2 > k 1 , we pick the k 2 factors that make the largest contributions to the factorization and solve as before. The following algorithm formalizes this approach.

Updating the factorization with a new k

Similarly, we can efficiently compute a factorization with a new λ value. Assume a previous optimization with k factors and λ 1 , and with matrices H i ( n i × k ) , V i ( k × g ) , and W ( k × g ) . To compute a new factorization with λ 2 > λ 1 , we can use the matrices H i and W and simply reoptimize with the new λ value. Empirical benchmarks for updating factorizations with new k and λ values are shown in Figure S1C - D .

Suppose we have optimized (1) with k factors to give matrices H i ( n i × k ) , V i ( k × g ) , and W ( k × g ) To efficiently compute a factorization incorporating new data from the same condition as an existing dataset, we use the previous W and V matrices as initial values and find the optimal H given this starting point. Given a new dataset altogether, we initialize the W and V matrices using the values from the dataset that we expect a priori to be the most similar and find the optimal H given these values. To re-run on a subset of the data, we use the W and V matrices as a starting point and simply drop the H rows corresponding to the omitted data. For each case, we subsequently perform optimization using the same block coordinate descent strategy as described above. Algorithm 2 summarizes this approach. Empirical benchmarks for updating factorizations with subsets of data and new data are shown in Figure S1E - F .

Adding new data to the factorization

We devised novel heuristics to aid in selecting the number of factors k and the tuning parameter λ . To choose k , we calculate the Kullback-Leibler divergence (compared to a uniform distribution) of the factor loadings for each cell and plot the median across cells as a function of k . We then try to observe a saturation point in the curve, corresponding to the point at which more factors do not significantly change the sparsity of the factor loadings or correspondingly increase the median KL divergence. The intuition behind this heuristic is that, if the number of factors is too low, factors will encode combinations of clusters, and thus cells will load on multiple factors, with the distribution of factor loadings for a particular cell approaching a uniform distribution. As the number of factors approaches the “true” number of clusters in the dataset, each cell will generally be expected to load on only a few factors. To select an appropriate lambda, we plot the alignment metric (after performing factorization and basic alignment with default parameters) as a function of lambda and again choose the minimum value at which the alignment metric saturates. KL divergence curves and alignment-lambda curves for two benchmark datasets are shown in Figures S1l - j

After optimizing the iNMF objective function, we use the factor space to identify corresponding cell types across datasets ( Figure 1C ). Because of the parts-based nature of the factorization, cells can be clustered by simply assigning each cell to the factors on which they have the highest loading. This is a common way of performing clustering using NMF representations ( Xu, 2003 ). If we perform such simple assignment, we get clusters that correspond across datasets, because the factors represent the same signal in each dataset. However, we noticed that simple maximum factor assignments sometimes produced spurious alignments in highly divergent datasets. Therefore, we developed a novel clustering strategy that better leverages the dataset-specific information in the factorization to increase the robustness of the joint clustering results. We build a shared factor neighborhood graph in which we connect cells across datasets that have similar factor loading patterns, then identify joint clusters by performing community detection on this graph.

More specifically, we build the shared factor neighborhood (SFN) graph as follows: Build k -nearest neighbor graphs separately for each dataset using the H factor loadings Annotate each cell i with the H factor on which the cell has the highest loading; call this F ( i ). We scale each factor to unit variance before assigning F ( i ) values, as is standard with NMF ( Xu, 2003 ). For each cell i , collect the “factor neighborhood” vector FN ( i ) by computing a histogram of F ( i ) for each of its k nearest neighbors. Calculate Manhattan distance between pairs of cells ( i,j ) across (and within) datasets using the factor neighborhood vectors FN ( i ) and FN ( j ) Connect pairs of cells with low distance; these represent cells with shared factor neighborhoods.

Build k -nearest neighbor graphs separately for each dataset using the H factor loadings

Annotate each cell i with the H factor on which the cell has the highest loading; call this F ( i ). We scale each factor to unit variance before assigning F ( i ) values, as is standard with NMF ( Xu, 2003 ).

For each cell i , collect the “factor neighborhood” vector FN ( i ) by computing a histogram of F ( i ) for each of its k nearest neighbors.

Calculate Manhattan distance between pairs of cells ( i,j ) across (and within) datasets using the factor neighborhood vectors FN ( i ) and FN ( j )

Connect pairs of cells with low distance; these represent cells with shared factor neighborhoods.

We then perform Louvain community detection on the graph to jointly identify cell clusters across datasets (Waltman and van Eck, 2013).

One intuition behind this construction is that, within an individual dataset, it is much more likely for an individual cell to have a spurious maximum factor loading than for an entire neighborhood of cells to be incorrectly assigned. Thus, leveraging the neighborhood of a cell in assigning it to a cluster increases the robustness of the assignment. This approach is synergistic with iNMF, which reconstructs each dataset separately, accurately preserving the structure of individual datasets. A recent paper used a related idea to refine cluster assignments from NMF by taking into account the neighborhood of each data point ( Tripodi, 2016 ). Additionally, our graph construction greatly reduces the chances of spurious matches across datasets, because even if a cell type spuriously loads on the same factor as a different cell type in another dataset, they are unlikely to have the same factor neighborhoods.

After performing SFN clustering, we choose a reference dataset (by default the dataset with the largest number of cells) and normalize the quantiles of the factor loadings for each joint cluster in the other datasets to match the quantiles of the reference dataset for that joint cluster. We require that each dataset have a minimum number of cells assigned to a particular cluster (default: 2 cells); cells not satisfying this requirement are not normalized.

We calculated the alignment metric as defined in Butler et al. ( Butler et al., 2018 ). To quantify how well the integrated factor space respects the geometry of each individual dataset, we calculate an “agreement metric” as follows. We first apply a dimensionality reduction technique to each dataset separately. Using these low-dimensional representations, we build a k -nearest neighbor graph for each dataset. We also build k -nearest neighbor graphs for each dataset using the joint, integrated space—the normalized H factor loadings from LIGER or the aligned canonical components from Seurat. We then count how many of each cell’s nearest neighbors in the graphs built from the separate low-dimensional representations are also nearest neighbors in the graphs built from the integrated low-dimensional representations. We found that PCA and NMF produced significantly different graphs for different joint dimensionality reduction and alignment techniques, so to ensure a fair comparison, we compared the graphs built from the aligned Seurat space (CCA-based) with graphs built from PCA, and compared the graphs built from the aligned LIGER factor loadings (iNMF-based) with NMF.

For comparisons with Seurat, we followed all documented procedures for running the method, including choosing the number of canonical components. For the PBMC and pancreas datasets, we reproduced the analyses as described by Butler et al. and subsequent Seurat tutorials ( Butler et al., 2018 ).

Tissue was sliced from the anterior until reaching the target region of interest ( Figure S3A ). To dissect a tissue segment, the block face was punched with a 1 mm biopsy punch, and a 400-micron slice was made to liberate the circular tissue segments from the remaining brain. Nuclei were extracted from frozen tissue using gentle, detergent-based dissociation, according to a protocol generously provided by the McCarroll lab ( http://mccarrolllab.org/resources/ ), and loaded into the 10x Chromium V3 system. Reverse transcription and library generation were performed according to the manufacturer’s protocol.

Frozen tissue samples were sectioned on a cryostat to visualize pigmentation of the pars compacta, and manually dissected to remove as much surrounding tissue as possible. Nuclei from the dissected tissue segments were then immediately isolated ( Saunders et al., 2018 ) and profiled on the 10x Chromium V2 system, according to the manufacturer’s protocol.

## QUANTIFICATION AND STATISTICAL ANALYSIS
We performed a first round of LIGER analysis on BNST nuclei to identify neurons, then restricted subsequent analyses to neuronal cells. We next assigned neuronal populations to anatomical locations using in situ staining data from the Allen Brain Atlas ( Figure S3 ), then performed a second round of clustering on neurons we could assign to the bed nucleus. Clustering of bed nucleus neurons identified 46 populations, three of which were removed because of artifactual signatures (high expression of mitochondrial genes, activity-related genes, or doublets), and two small clusters that expressed markers localizing them outside the boundaries of BNST (Islands of Calleja and lateral septum, respectively). We found it was not necessary to quantile normalize the factor spaces for the bed nucleus analyses, as iNMF alone provides sufficient batch effect correction in this case.

To identify genes with statistically significant dimorphic expression, we performed a bootstrapping procedure designed to control for biological variation within each sex. To do this, we sampled between 1 and 8 replicates uniformly at random from the male mice, sampled between 1 and 7 replicates uniformly at random from the female mice, and computed the male/female fold change for each gene in each cluster for each bootstrap sample. We performed 1000 bootstrap samples. This analysis yielded empirical distributions for the fold changes of each gene in each cluster under the biological variation within each sex. We report these values in Supplementary File 1 . To further identify a high-confidence set of dimorphic genes shown in Figure 3i , we retained only genes for which (1) log2(fold change) was greater than 0.5 with 95% confidence; (2) the gene was expressed in at least 10% of the cells in the sex with the higher expression; and (3) the gene was expressed in no more than 25% of the cells in the sex with the lower expression. These filters were designed to remove genes with subtle expression shifts and genes with extremely low expression.

We also used the iNMF factorization to identify genes with dimorphic expression by simply taking the genes with nonzero loadings on the dataset-specific factors V . As an additional filtering step, for gene i loading on dataset-specific factor j we removed i if it had a log fold change of less than 0.75 or fewer than 30 UMIs in the cells with their highest factor loading values on factor j . For the analysis in Fig. 3j , we also restricted to only factors with high loadings on the BNSTp and BNSTpr clusters, which showed the highest number of dimorphic genes in our bootstrapping analysis and were previously shown to be the most dimorphic anatomical region of the BNST ( Xu et al., 2012 ). To rank dimorphic genes by their degree of dimorphism (as shown in Figure 3K ), we calculated the difference, for each gene, between male and female dataset specific factor loadings for the factors on which the gene is dimorphic.

For the comparison of BNST_Vip and BNSTp_Cplx3 nuclei with CGE-derived cortical interneurons, we randomly sampled 100 cells from each of the 11 published subclusters of frontal cortex global cluster 1 ( Saunders et al., 2018 ), to maintain cell-type diversity in the downsampled set. These 1,060 CGE neurons were analyzed with the 352 BNST_Vip and BNSTp_Cplx3 profiles with LIGER according to parameters in Table S1 . For the comparison of the Ppp1r1b+ BNST populations with striatal SPNs, we sampled 5,000 dSPNs (published global cluster 10), 5,000 iSPNs (published global cluster 11), and 934 eSPNs (subclusters 1-5 of global cluster 13). These 10,934 SPNs were analyzed with the 8,624 Ppp1r1b+ nuclei from the BNST analysis using LIGER with the parameters in Table S1 . For the SPN co-clustering, to reduce over-clustering of dominant populations, the quantile-aligned factors were re-clustered using the SLM algorithm ( Gierahn et al., 2017 ), with a resolution parameter setting of 1.2.

To analyze the human substantia nigra data across donors, we used a separate dataset-specific factor matrix for each human donor. We performed two rounds of clustering with LIGER, first identifying the main cell classes (neurons, endothelial cells, astrocytes, oligodendrocytes, and microglia), then clustering each cell type again to identify additional substructure within these classes ( Saunders et al., 2018 ). For the cross-species analysis, we determined homology relationships using Jackson Laboratories annotations ( http://www.informatics.jax.org ) and included only genes with one-to-one homologs. We used LIGER to integrate each broad cell class separately, and used two dataset-specific factor matrices (one for each species), rather than treating the data from each human donor as a separate dataset. For the cross-species analysis, we performed variable gene selection on each species separately, then took the union of variable genes across both species.

For the identification of gene ontology categories with conserved patterns of expression across species, we used GOrilla ( Eden et al., 2009 ) in ranked gene list mode, using default settings, to perform gene ontology enrichment analysis and ReviGO ( Supek et al., 2011 ) to summarize and visualize the results.

We downloaded the published STARmap expression data and segmented cell boundaries, then normalized and scaled the STARmap gene counts in the same manner as the Drop-seq data of mouse frontal cortex ( Saunders et al., 2018 ). Because the STARmap data assays pre-selected markers, we did not perform variable gene selection, but used all genes that were present in both the Drop-seq and STARmap data. We used the entire frontal cortex dataset from a previously published Drop-seq atlas of mouse brain. We performed two levels of analysis using LIGER, first jointly identifying broad cell classes, then performing a second round of LIGER analysis on excitatory neurons, inhibitory neurons, and glia.

We developed a simple method for predicting the spatial distributions of genes not measured in STARmap data. To do this, we simply compute a cross-dataset k -nearest neighbor graph in the aligned factor space. Then we set the value of each missing gene to the unweighted arithmetic mean of its k nearest neighbors in the other dataset. We used k=50 for all analyses in the paper. We assessed the accuracy of the predicted genes by calculating mean absolute deviation (MAD) from the measured STARmap values for genes present in both datasets. As a baseline model, we predicted each gene by setting the value of each gene in each STARmap cell to its average value in the Drop-seq cells within the joint cluster to which the STARmap cell was assigned. We found that our knn prediction strategy resulted in lower MAD than the baseline model for 938 of 989 genes. Visual inspection of genes with clear spatial trends showed that LIGER is able to capture even complex spatial expression patterns ( Figure S5 ). Our predictions agreed strongly with corresponding in situ hybridization data of the same genes in the Allen Brain Atlas ( Figure S5 )

To investigate failure modes of the spatial prediction, we sorted genes present in both STARmap and Drop-seq by their prediction error (defined as MAD between measured and imputed values) and plotted the 10 genes with highest error ( Figure S5 ).

We downloaded the publicly available gene-level mCH fractions from 3378 frontal cortex profiles ( Luo et al., 2017 ). Because gene expression and gene body mCH are generally anticorrelated, we created gene-level methylation features that correspond to gene expression features by calculating max ( X ) − X where X is the matrix of mCH values. Because the data from Luo et al. contains only neuronal cells, we used only cells annotated as neurons from the Saunders et al. frontal cortex Drop-seq dataset.

Because the distribution of methylation values is very different from scRNA-seq data, we selected genes by performing a Kruskal-Wallis test on methylation and RNA data separately using the published clusters, then taking the intersection of the top 8000 RNA and methylation markers. We found that, since the methylation data are not sparse (i.e., very few values are exactly 0), the NMF factor loadings need to be centered as well as scaled during the SFN clustering procedure. We also noted that the standard multiplicative update NMF algorithm converges extremely slowly compared to our ALS implementation when running on the non-sparse methylation data. We used the methylpy Python package to calculate methylation levels for the set of differentially methylated regions identified in the original analysis of the methylation data ( Luo et al., 2017 ). We performed an analysis of transcription factor binding using FIMO ( Grant et al., 2011 ) with default settings and the mouse transcription factor binding motifs from the latest version of the non-redundant JASPAR database ( Khan et al., 2018 ). We annotated the DMRs according to the nearest gene using the annotate R package.

We identified a set of sequence elements that: (1) showed no overlap with any annotated genes or promoters; (2) showed significant cell-type-specific DNA methylation; (3) contain a conserved sequence element; (4) contain a binding motif for a transcription factor that is expressed in the dataset; and (5) have a methylation profile that is anticorrelated with the expression of the transcription factor whose binding motif occurs in the region. To construct the network of predicted transcription factor/differentially methylated region interactions shown in Figure 7 , we identified the transcription factors that showed statistically significant expression differences among neuronal populations (using a Wilcoxon test). Then we identified, for each TF, the top 10 anticorrelated DMRs satisfying the above criteria. Using this set of TFs and DMRs, we connected any TF and DMR for which the correlation between TF expression and DMR methylation across the set of joint LIGER clusters was less than −0.45.

## DATA AND SOFTWARE AVAILABILITY
LIGER is freely available as an R package: https://github.com/MacoskoLab/liger

The mouse bed nucleus and human substantia nigra single nucleus RNA-seq data have been deposited in the Gene Expression Omnibus under accession code GSE126836.

## Supplementary Material
Data S1: 95% confidence intervals for male/female fold changes as determined by bootstrapping and list of high-confidence dimorphic genes. Related to Figure 3 .

Figure S1. Parameter selection and fast updating. Related to Figure 1 . (a) Comparison of reconstructed PBMC 10X gene expression values for iNMF vs. NMF, PCA, and scVI (Spearman correlation indicated). (b) Comparison of reconstructed values and original gene expression values. Comparison calculated for random 1% sample of non-zero values for (a) and (b). Mean squared error values are displayed for each method. (c-d) Comparison of objective function value as a function of running time for our ALS implementation of iNMF and the original multiplicative update algorithm, for the (c) PBMC datasets and the (d) human-mouse pancreas datasets. Our ALS implementation converged in less time than the original algorithm on these datasets for two different values of k . (e) Comparison of fast updating strategy vs. simple recalculation for changing k from 22 to 12. (f) Comparison of fast updating strategy vs. simple recalculation for changing λ from 22 to 12. (g)-(h) Fast updating for (g) subsetting the data and (h) adding new data. (i)-(j) Parameter selection heuristics for (i) PBMC dataset and (j) pancreas dataset. Error bars represent 95% confidence intervals from twenty random iNMF initializations for KL divergence plots and ten random initializations for lambda-alignment plots.

Figure S2. Comparison of LIGER and Seurat for PBMCs and hippocampal cells. Related to Figure 2 . (a)-(c) Two-dimensional visualizations of CCA/Seurat (left)and LIGER (right) analyses of (a) PBMC, (b) human and mouse pancreas, and (c) hippocampal interneuron and oligodendrocyte analyses that are shown in Figure 2 , colored here by published cluster assignments. (d)-(e) River plots comparing clustering in individual and joint LIGER analyses of (d) interneuron and oligodendrocyte cells and (e) mouse and human pancreas data.

Figure S3. Markers used to identify cell clusters from the bed nucleus. Related to Figure 3 . (a) Diagram of dissection strategy for isolating BNST. Arrays denote the dissected tissue fragments for profiling. (b) t-SNE visualization of LIGER analysis of 106,728 nuclei identified as neurons amongst the 204,737 nuclei profiled from the tissue dissected in (a) . Colored clusters (70.2%) are annotated as localized to BNST; gray clusters were localized to adjacent structures or had an indeterminate localization and were not included in the analysis shown in Figure 3a . (c) Dot plot of markers of neurochemical identity, and cluster, across the 41 clusters identified in the analysis shown in Figure 3a . (d) Images showing ISH signals within BNST for marker genes plotted in (c). Arrows indicate signal within BNST region(s). S, sagittal section; C, coronal section; aco, anterior commissure; act, anterior commissure, temporal limb; fx, fornix; st, stria terminalis; v3, third ventricle; CP, caudate putamen; HY, hypothalamus; LS, lateral septum; MS, medial septum; TH, thalamus; SI, substantia innominata. (e) Dot plot of SPN marker expression across clusters identified in the all-neuron analysis shown in (b). Stars indicate the clusters selected for the SPN analyses in Figures 3f - h .

Figure S4. Cross-species LIGER analyses of additional cell classes not displayed in Figure 4 . Related to Figure 4 . (a) Two-dimensional UMAP representation of a standard Seurat analysis (all datasets merged and scaled together) of the human substantia nigra dataset, colored by donor. (b)-(f) Two-dimensional UMAP representations of LIGER human-mouse subanalyses of individual SN cell classes, including (b) oligodendrocytes, (c) endothelial cells, (d) microglia, (e) astrocytes, and (f) neurons. (g) Proportional representation of human nuclei and mouse cells in clusters annotated in the neuron analysis. SNc, substantia nigra pars compacta; VTA, ventral tegmental area; SNr, substantia nigra pars reticulata; PP, peripeduncular nucleus; RN, red nucleus. (h) Schematic representation of the dissected region of human substantia nigra (dotted oval), sparing several surrounding structures, including the red nucleus. Atlas image is reproduced from the Allen Human Brain Atlas (Ding et al., 2016).

Figure S5. Integration of STARmap and Drop-seq and prediction of spatial gene expression trends. Related to Figure 5 . (a) Dot plot showing relative proportions of each joint cluster in STARmap and Drop-seq datasets. The color of each dot indicates the cluster and the size indicates the proportion of cells belonging to that cluster. (b)-(d) Measured STARmap (b), Drop-seq predicted (c), and Allen Brain Atlas (d) expression levels for selected genes present in both STARmap and Drop-seq datasets. (e)-(g) Measured STARmap (e), Drop-seq predicted (f), and Allen Brain Atlas (g) expression levels for genes present in both STARmap and Drop-seq datasets with the 10 highest mean absolute deviation values between measured and predicted values.

Figure S6. Marker gene plots and additional LIGER sub-analyses of joint RNA and methylation. Related to Figure 6 . (a)-(b) Boxplots are shown highlighting gene expression (top) and methylation (bottom), for selected marker genes of (a) cluster L5b and (b) cluster MGE_7 (Th+). (c)-(e) Two-dimensional tSNE representation of LIGER RNA-methylation sub-analyses of (c) CGE interneurons, (d) upper layer excitatory neurons, and (e) lower layer excitatory neurons, colored by measurement modality (top) and cluster identity (bottom).

Figure S7. Relationship between global methylation and expression of methylation machinery. Related to Figure 7 . (a) Predicted spatial expression and methylation patterns. The top row contains expression values predicted by mapping Drop-seq into STARmap coordinates and the bottom row contains methylation values mapped to Drop-seq, then to STARmap. Note that there are fewer cells in these plots than in Figure S5 because methylation values are available only for neuronal cells. (b)-(c) Density plots comparing the correlation between gene body mCH and gene body mCG with gene expression. The correlations were computed across the LIGER joint methylation and expression clusters. Panel (c) shows both mCH and mCG correlations for all genes and genes within mCH deserts. (d)-(e) Plots showing the difference in cluster separation when using gene body mCG (d) or mCH (e). (f)-(j) Relationship of expression versus global methylation for selected methylation machinery components. Red dots are inhibitory neuron clusters; black are excitatory neuron clusters, defined by the joint LIGER analysis. (k) Correlation of methylation and expression of nearest gene as a function of distance to transcriptional start site.

Table S1: LIGER parameter settings of analyses featured in main figure panels. Related to Figure STAR Methods .